<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lunix OS - Advanced</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <style>
        /* Spinner animasyonu */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
        /* ========== YENİ BOOT EKRANI STİLLERİ ========== */

/* Kursör yanıp sönme efekti */
@keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0; }
}

/* Loading spinner dönme efekti */
@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Hazırlık mesajı animasyonu */
@keyframes fadeInOut {
    0% { opacity: 0; transform: translateY(20px); }
    20% { opacity: 1; transform: translateY(0); }
    80% { opacity: 1; transform: translateY(0); }
    100% { opacity: 0; transform: translateY(-20px); }
}

/* Terminal kursörü */
.terminal-cursor {
    display: inline-block;
    width: 8px;
    height: 16px;
    background-color: #0f0;
    margin-left: 2px;
    animation: blink 1s infinite;
    vertical-align: middle;
}

/* Loading spinner */
.loading-spinner {
    display: inline-block;
    width: 16px;
    height: 16px;
    border: 2px solid #333;
    border-radius: 50%;
    border-top-color: #0f0;
    animation: spin 1s linear infinite;
    margin-left: 8px;
    vertical-align: middle;
}

/* Hazırlık ekranı */
.preparation-screen {
    position: fixed;
    inset: 0;
    background: #ffffff;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 100000;
    opacity: 0;
    transition: opacity 1s ease;
}

.preparation-message {
    color: #8B4513;
    font-size: 1.8rem;
    font-weight: bold;
    animation: fadeInOut 5s ease-in-out;
}
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-window: rgba(18, 18, 26, 0.95);
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: rgba(255, 255, 255, 0.08);
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --glass: rgba(255, 255, 255, 0.03);
            --blur-amount: 20px;
            --remote-success: #00ff9d;
            --remote-warning: #ffb74d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            font-size: var(--font-size, 14px);
            user-select: none;
            cursor: url('default.cur'), auto;
        }

        #brightness-overlay {
            position: fixed;
            inset: 0;
            background: black;
            opacity: 0;
            pointer-events: none;
            z-index: 99999;
            transition: opacity 0.3s ease;
        }

        #night-light-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 147, 41, 0.15);
            opacity: 0;
            pointer-events: none;
            z-index: 99998;
            transition: opacity 0.3s ease;
        }

        #blue-screen {
            position: fixed;
            inset: 0;
            background: #0a5cdf;
            color: white;
            z-index: 1000000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'JetBrains Mono', monospace;
            padding: 40px;
            animation: blueScreenIn 0.5s ease;
        }

        @keyframes blueScreenIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .blue-screen-emoji {
            font-size: 80px;
            margin-bottom: 30px;
        }

        .blue-screen-title {
            font-size: 40px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .blue-screen-text {
            font-size: 18px;
            max-width: 600px;
            text-align: center;
            line-height: 1.5;
            margin-bottom: 30px;
        }

        .blue-screen-progress {
            width: 300px;
            height: 6px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .blue-screen-progress-bar {
            height: 100%;
            background: white;
            width: 0%;
            transition: width 3s ease;
        }

        /* BOOT SCREEN - GÜNCELLENDİ */
        #boot-screen {
            position: fixed;
            inset: 0;
            background: #000;
            z-index: 100001;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #0f0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            opacity: 1;
            visibility: visible;
            transition: opacity 0.5s ease;
            width: 100vw;
            height: 100vh;
        }

        #boot-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .boot-logo {
            color: #0f0;
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #0f0;
        }

        .boot-text {
            color: #0f0;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .boot-progress {
            width: 300px;
            height: 2px;
            background: rgba(0, 255, 0, 0.3);
            border-radius: 1px;
            overflow: hidden;
        }

        .boot-progress-bar {
            height: 100%;
            background: #0f0;
            width: 0%;
            transition: width 0.3s ease;
        }

        .boot-messages {
            margin-top: 20px;
            text-align: left;
            width: 500px;
            height: 200px;
            overflow: hidden;
            border: 1px solid rgba(0, 255, 0, 0.2);
            padding: 10px;
            background: rgba(0, 20, 0, 0.5);
        }

        .boot-message {
            margin-bottom: 5px;
            color: #0f0;
            font-size: 12px;
            opacity: 0.8;
        }

        /* USER SELECT SCREEN - GÜNCELLENDİ */
        #user-select-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            width: 100vw;
            height: 100vh;
        }

        #user-select-screen.active {
            opacity: 1;
            visibility: visible;
        }

        .user-select-title {
            font-size: 28px;
            font-weight: 300;
            margin-bottom: 40px;
        }

        .user-list {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 40px;
        }

        .user-card {
            width: 200px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .user-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
            transform: translateY(-5px);
        }

        .user-card-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            margin: 0 auto 15px;
        }

        .user-card-name {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .user-card-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .add-user-btn {
            width: 200px;
            padding: 30px 20px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .add-user-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent);
        }

        .add-user-btn i {
            font-size: 40px;
            color: var(--text-muted);
        }

        /* LOCK SCREEN - GÜNCELLENDİ */
        #lock-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            z-index: 100000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease;
            width: 100vw;
            height: 100vh;
        }

        #lock-screen.active {
            opacity: 1;
            visibility: visible;
        }

        #lock-screen::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.2) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(139, 92, 246, 0.15) 0%, transparent 50%);
            animation: lockBgPulse 8s ease-in-out infinite;
        }

        @keyframes lockBgPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .lock-content {
            position: relative;
            z-index: 1;
            text-align: center;
            animation: lockSlideUp 0.6s ease;
        }

        @keyframes lockSlideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .lock-time {
            font-size: 96px;
            font-weight: 200;
            letter-spacing: -4px;
            margin-bottom: 8px;
            background: linear-gradient(180deg, #fff 0%, rgba(255,255,255,0.7) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .lock-date {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 60px;
            font-weight: 300;
        }

        .lock-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 20px;
            box-shadow: 0 10px 40px rgba(99, 102, 241, 0.4);
            animation: avatarFloat 3s ease-in-out infinite;
        }

        @keyframes avatarFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .lock-username {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 24px;
        }

        .lock-password-container {
            position: relative;
            margin-bottom: 20px;
        }

        .lock-password {
            width: 280px;
            padding: 14px 50px 14px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            color: white;
            font-size: 16px;
            outline: none;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .lock-password:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--accent);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .lock-password::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .lock-submit {
            position: absolute;
            right: 6px;
            top: 50%;
            transform: translateY(-50%);
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: var(--accent);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .lock-submit:hover {
            background: var(--accent-hover);
            transform: translateY(-50%) scale(1.1);
        }

        .lock-hint {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 30px;
        }

        .lock-back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lock-back-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        #desktop {
            position: relative;
            width: 100%;
            height: calc(100% - 56px);
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            background-size: cover;
            background-position: center;
            overflow: hidden;
            transition: background 0.5s ease;
        }

        #desktop::before {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(ellipse at 30% 20%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
                        radial-gradient(ellipse at 70% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        /* Remote Control Overlay - REMOVED */
        #remote-control-overlay {
            display: none !important;
        }

        .workspace-indicator {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            z-index: 9997;
        }

        .workspace-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .workspace-dot.active {
            background: var(--accent);
            transform: scale(1.3);
        }

        .desktop-icon {
            position: absolute;
            width: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 5px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .desktop-icon:hover {
            background: rgba(255, 255, 255, 0.08);
            transform: scale(1.05);
        }

        .desktop-icon.selected {
            background: rgba(99, 102, 241, 0.25);
            box-shadow: 0 0 0 2px var(--accent);
        }

        .desktop-icon.dragging {
            opacity: 0.7;
            transform: scale(1.1);
            z-index: 1000;
        }

        .desktop-icon .icon {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 6px;
            transition: transform 0.3s ease;
            position: relative;
        }

        .desktop-icon:hover .icon {
            transform: translateY(-2px);
        }

        .desktop-icon .label {
            font-size: 11px;
            font-weight: 500;
            text-align: center;
            color: var(--text-primary);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            word-wrap: break-word;
            max-width: 100%;
        }

        .icon-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
        }

        .icon-terminal { background: linear-gradient(135deg, #1e1e2e, #313244); color: #a6e3a1; }
        .icon-files { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .icon-settings { background: linear-gradient(135deg, #64748b, #475569); color: white; }
        .icon-taskmgr { background: linear-gradient(135deg, #0ea5e9, #0284c7); color: white; }
        .icon-users { background: linear-gradient(135deg, #ec4899, #db2777); color: white; }
        .icon-browser { background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; }
        .icon-trash { background: linear-gradient(135deg, #6b7280, #4b5563); color: white; }
        .icon-remote { background: linear-gradient(135deg, #00ff9d, #00cc7a); color: #000; }

        #taskbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 12px;
            z-index: 9999;
        }

        #start-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            transition: all 0.3s ease;
            margin-right: 8px;
        }

        #start-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 0 25px var(--accent-glow);
        }

        .taskbar-divider {
            width: 1px;
            height: 30px;
            background: var(--border);
            margin: 0 8px;
        }

        #search-btn {
            width: 200px;
            height: 38px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 14px;
            gap: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 8px;
        }

        #search-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        #taskbar-apps {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 10px;
        }

        .taskbar-app {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--glass);
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .taskbar-app:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .taskbar-app.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--accent);
        }

        .taskbar-app.active::after {
            content: '';
            position: absolute;
            bottom: -8px;
            width: 20px;
            height: 3px;
            background: var(--accent);
            border-radius: 2px;
        }

        #taskbar-tray {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0 8px;
        }

        .tray-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s ease;
            position: relative;
        }

        .tray-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .tray-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
        }

        #taskbar-clock {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        #taskbar-clock:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .window {
            position: absolute;
            min-width: 400px;
            min-height: 300px;
            background: var(--bg-window);
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 1px var(--border);
            backdrop-filter: blur(var(--blur-amount));
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 100;
            animation: windowOpen 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .window.closing {
            animation: windowClose 0.25s ease-out forwards;
        }

        .window.minimizing {
            animation: windowMinimize 0.3s ease-out forwards;
        }

        .window.crashed {
            pointer-events: none;
            opacity: 0.7;
        }

        .window.snap-left {
            animation: snapLeft 0.3s ease-out forwards;
        }

        .window.snap-right {
            animation: snapRight 0.3s ease-out forwards;
        }

        .window.snap-top {
            animation: snapTop 0.3s ease-out forwards;
        }

        .window.pinned {
            z-index: 1000;
            box-shadow: 0 0 0 2px var(--accent);
        }

        .window.highlight {
            box-shadow: 0 0 0 3px var(--accent), 0 25px 80px rgba(99, 102, 241, 0.3);
            transition: box-shadow 0.3s ease;
        }

        @keyframes windowOpen {
            from { opacity: 0; transform: scale(0.9) translateY(20px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        @keyframes windowClose {
            to { opacity: 0; transform: scale(0.9) translateY(20px); }
        }

        @keyframes windowMinimize {
            to { opacity: 0; transform: scale(0.5) translateY(100px); }
        }

        @keyframes snapLeft {
            to { left: 0 !important; top: 0 !important; width: 50% !important; height: calc(100% - 56px) !important; border-radius: 0; }
        }

        @keyframes snapRight {
            to { left: 50% !important; top: 0 !important; width: 50% !important; height: calc(100% - 56px) !important; border-radius: 0; }
        }

        @keyframes snapTop {
            to { left: 0 !important; top: 0 !important; width: 100% !important; height: calc(100% - 56px) !important; border-radius: 0; }
        }

        @keyframes workspaceSlideLeft {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(-100%); opacity: 0; }
        }

        @keyframes workspaceSlideRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        @keyframes workspaceSlideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes workspaceSlideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .window-header {
            height: 44px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            padding: 0 14px;
            cursor: move;
            flex-shrink: 0;
        }

        .window-controls {
            display: flex;
            gap: 8px;
            margin-right: 14px;
        }

        .window-control {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: transparent;
        }

        .window-control:hover {
            color: rgba(0, 0, 0, 0.7);
        }

        .window-control.close { background: #ff5f57; }
        .window-control.minimize { background: #febc2e; }
        .window-control.maximize { background: #28c840; }
        .window-control.pin { background: #8b5cf6; }

        .window-title {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .window-content {
            flex: 1;
            overflow: auto;
            padding: 16px;
        }

        .window-content::-webkit-scrollbar { width: 8px; }
        .window-content::-webkit-scrollbar-track { background: transparent; }
        .window-content::-webkit-scrollbar-thumb { background: var(--text-muted); border-radius: 4px; }

        .crash-overlay {
            position: absolute;
            inset: 0;
            background: rgba(239, 68, 68, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            z-index: 1000;
            animation: crashShake 0.5s ease;
        }

        @keyframes crashShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .crash-overlay i {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .crash-overlay h3 {
            font-size: 20px;
            margin-bottom: 10px;
        }

        .crash-overlay p {
            font-size: 14px;
            margin-bottom: 20px;
            opacity: 0.9;
        }

        .crash-btn {
            padding: 10px 20px;
            background: white;
            color: var(--danger);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }

        .crash-btn:hover {
            transform: scale(1.05);
        }

        #context-menu {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            min-width: 220px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: none;
            animation: menuOpen 0.2s ease;
        }

        @keyframes menuOpen {
            from { opacity: 0; transform: scale(0.95) translateY(-5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .context-item {
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-primary);
            transition: background 0.15s ease;
        }

        .context-item:hover { background: rgba(99, 102, 241, 0.15); }
        .context-item.disabled { opacity: 0.4; pointer-events: none; }
        .context-item i { width: 18px; text-align: center; color: var(--text-secondary); }
        .context-divider { height: 1px; background: var(--border); margin: 6px 0; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
            z-index: 100001;
            animation: notifIn 0.4s ease;
            max-width: 350px;
        }

        .notification.closing { animation: notifOut 0.3s ease forwards; }

        @keyframes notifIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes notifOut { to { opacity: 0; transform: translateX(100px); } }

        .notification-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .notification-message {
            font-size: 12px;
            color: var(--text-secondary);
        }

        #start-menu {
            position: fixed;
            bottom: 68px;
            left: 12px;
            width: 420px;
            max-height: 600px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            z-index: 9998;
            display: none;
            animation: menuOpen 0.25s ease;
            overflow: hidden;
        }

        .start-menu-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .start-menu-logo {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .start-menu-brand h2 { font-size: 16px; font-weight: 600; }
        .start-menu-brand span { font-size: 11px; color: var(--text-muted); }

        .start-menu-user {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
        }

        .start-menu-user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }

        .start-menu-user-info {
            flex: 1;
        }

        .start-menu-user-name {
            font-size: 13px;
            font-weight: 500;
        }

        .start-menu-user-status {
            font-size: 11px;
            color: var(--text-muted);
        }

        .start-menu-apps {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            padding: 16px;
            max-height: 360px;
            overflow-y: auto;
        }

        .start-app {
            padding: 14px 6px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .start-app:hover { 
            background: rgba(255, 255, 255, 0.06); 
            transform: translateY(-2px); 
        }
        
        .start-app .icon { 
            width: 36px; 
            height: 36px; 
            border-radius: 10px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 16px; 
        }
        
        .start-app span { 
            font-size: 10px; 
            color: var(--text-secondary); 
            text-align: center; 
        }

        .start-menu-footer {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
        }

        .start-footer-btn {
            padding: 10px 16px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .start-footer-btn:hover { 
            background: rgba(255, 255, 255, 0.06); 
            color: var(--text-primary); 
        }
        
        .start-footer-btn.danger:hover { 
            background: rgba(239, 68, 68, 0.15); 
            color: var(--danger); 
        }

        .search-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: flex-start;
            justify-content: center;
            padding-top: 15vh;
            z-index: 10001;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .search-container {
            width: 600px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        .search-input-container {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            gap: 12px;
            border-bottom: 1px solid var(--border);
        }

        .search-input-container i { 
            color: var(--text-muted); 
            font-size: 18px; 
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 18px;
            color: var(--text-primary);
            outline: none;
        }

        .search-input::placeholder { 
            color: var(--text-muted); 
        }

        .search-results { 
            max-height: 400px; 
            overflow-y: auto; 
        }

        .search-result-item {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .search-result-item:hover { 
            background: rgba(255, 255, 255, 0.05); 
        }

        .search-result-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .search-result-info h4 { 
            font-size: 14px; 
            margin-bottom: 2px; 
        }
        
        .search-result-info span { 
            font-size: 12px; 
            color: var(--text-muted); 
        }

        /* POWER MENU - GÜNCELLENDİ */
        .power-menu {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100002;
            animation: fadeIn 0.3s ease;
            width: 100vw;
            height: 100vh;
        }

        .power-options {
            display: flex;
            gap: 30px;
        }

        .power-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            padding: 30px 40px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .power-option:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateY(-5px); 
        }

        .power-option i { font-size: 48px; }
        .power-option span { font-size: 14px; color: var(--text-secondary); }
        
        .power-option.shutdown:hover { 
            background: rgba(239, 68, 68, 0.2); 
        }
        .power-option.shutdown:hover i { color: var(--danger); }
        
        .power-option.restart:hover { 
            background: rgba(245, 158, 11, 0.2); 
        }
        .power-option.restart:hover i { color: var(--warning); }
        
        .power-option.lock:hover { 
            background: rgba(99, 102, 241, 0.2); 
        }
        .power-option.lock:hover i { color: var(--accent); }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100003;
            animation: fadeIn 0.2s ease;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            min-width: 400px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
        }

        .resize-handle::before {
            content: '';
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 8px;
            height: 8px;
            border-right: 2px solid var(--text-muted);
            border-bottom: 2px solid var(--text-muted);
            opacity: 0.5;
        }

        .window.maximized {
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 56px) !important;
            border-radius: 0;
        }

        .terminal-body {
            background: #0d0d0d;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            padding: 16px;
            height: 100%;
            color: #a6e3a1;
            overflow-y: auto;
        }

        .terminal-line { 
            margin-bottom: 4px; 
            line-height: 1.5; 
        }
        
        .terminal-prompt { 
            color: #89b4fa; 
        }

        .terminal-input-line { 
            display: flex; 
            align-items: center; 
        }

        .terminal-input {
            background: transparent;
            border: none;
            outline: none;
            color: #cdd6f4;
            font-family: inherit;
            font-size: inherit;
            flex: 1;
            caret-color: #f5e0dc;
        }

        .files-container { 
            display: flex; 
            height: 100%; 
            margin: -16px; 
        }

        .files-sidebar {
            width: 200px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--border);
            padding: 12px;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .files-sidebar-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            margin-bottom: 2px;
        }

        .files-sidebar-item:hover, 
        .files-sidebar-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--text-primary);
        }

        .files-main { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
        }

        .files-toolbar {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.15);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .files-toolbar-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }

        .files-toolbar-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .files-toolbar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .files-path {
            flex: 1;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            align-content: start;
        }

        .file-item {
            padding: 14px 8px;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .file-item:hover { 
            background: rgba(255, 255, 255, 0.06); 
        }
        
        .file-item.selected { 
            background: rgba(99, 102, 241, 0.2); 
            box-shadow: 0 0 0 2px var(--accent); 
        }
        
        .file-item.dragging {
            opacity: 0.5;
        }
        
        .file-item i { 
            font-size: 40px; 
            margin-bottom: 8px; 
        }
        
        .file-item span { 
            font-size: 11px; 
            text-align: center; 
            color: var(--text-secondary); 
            word-break: break-word; 
        }

        .settings-container { 
            display: flex; 
            height: 100%; 
            margin: -16px; 
        }

        .settings-nav {
            width: 220px;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--border);
            padding: 16px 12px;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .settings-nav-item {
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 13px;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            margin-bottom: 4px;
        }

        .settings-nav-item:hover { 
            background: rgba(255, 255, 255, 0.05); 
            color: var(--text-primary); 
        }
        
        .settings-nav-item.active { 
            background: var(--accent); 
            color: white; 
        }

        .settings-main {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .settings-section { 
            margin-bottom: 32px; 
        }
        
        .settings-title { 
            font-size: 20px; 
            font-weight: 600; 
            margin-bottom: 20px; 
        }

        .settings-group {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 14px;
            padding: 4px;
            margin-bottom: 16px;
        }

        .settings-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-radius: 10px;
            transition: background 0.2s ease;
        }

        .settings-row:hover { 
            background: rgba(255, 255, 255, 0.03); 
        }
        
        .settings-row-info h4 { 
            font-size: 14px; 
            font-weight: 500; 
            margin-bottom: 3px; 
        }
        
        .settings-row-info p { 
            font-size: 12px; 
            color: var(--text-muted); 
        }

        .toggle {
            width: 48px;
            height: 26px;
            background: var(--bg-tertiary);
            border-radius: 13px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s ease;
        }

        .toggle.active { 
            background: var(--accent); 
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: transform 0.3s ease;
        }

        .toggle.active::after { 
            transform: translateX(22px); 
        }

        .slider-container { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }

        .slider {
            width: 150px;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover { 
            transform: scale(1.1); 
        }
        
        .slider-value { 
            font-size: 13px; 
            font-weight: 500; 
            min-width: 45px; 
            text-align: right; 
        }

        select.settings-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            outline: none;
        }

        .color-options { 
            display: flex; 
            gap: 8px; 
        }

        .color-option {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid transparent;
        }

        .color-option:hover { 
            transform: scale(1.15); 
        }
        
        .color-option.active { 
            border-color: white; 
        }

        input[type="file"] { 
            display: none; 
        }

        .drag-drop-overlay {
            position: fixed;
            inset: 0;
            background: rgba(99, 102, 241, 0.2);
            border: 4px dashed var(--accent);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10004;
            pointer-events: none;
        }

        .drag-drop-overlay.active {
            display: flex;
        }

        .drag-drop-text {
            font-size: 24px;
            font-weight: 600;
            color: var(--accent);
        }

        .file-preview {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            max-width: 500px;
            max-height: 400px;
            display: none;
            z-index: 1000;
        }

        .file-preview img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 12px;
        }

        .file-preview-content {
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .notification-history {
            height: 100%;
            overflow-y: auto;
            padding: 16px;
        }

        .notification-history-item {
            padding: 16px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-bottom: 12px;
        }

        .webcam-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .webcam-preview {
            width: 320px;
            height: 240px;
            background: rgba(0,0,0,0.5);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .code-editor {
            height: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            background: #1e1e2e;
            color: #cdd6f4;
            border: none;
            outline: none;
            resize: none;
            padding: 20px;
            line-height: 1.5;
        }

        .debug-console {
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 300px;
            height: 200px;
            background: rgba(0,0,0,0.9);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: #22c55e;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }

        .debug-log {
            margin-bottom: 4px;
            opacity: 0.8;
        }

        .corrupted-file {
            animation: corruptFlash 0.5s infinite;
        }

        @keyframes corruptFlash {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .selection-box {
            position: absolute;
            border: 2px solid var(--accent);
            background: rgba(99, 102, 241, 0.1);
            z-index: 999;
            display: none;
        }

        /* Remote Control Settings */
        .remote-settings {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .code-input-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .code-digit {
            width: 60px;
            height: 70px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            text-align: center;
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
            transition: all 0.2s;
            outline: none;
        }

        .code-digit:focus {
            border-color: var(--remote-success);
            background: rgba(0, 255, 157, 0.05);
            box-shadow: 0 0 0 3px rgba(0, 255, 157, 0.1);
        }

        .code-digit.filled {
            border-color: var(--remote-success);
            background: rgba(0, 255, 157, 0.1);
        }

        .remote-connect-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--remote-success), #00cc7a);
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .remote-connect-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 157, 0.4);
        }

        .remote-connect-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .remote-connect-btn.connecting {
            background: linear-gradient(135deg, var(--warning), #d97706);
        }

        .remote-status-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
        }

        .remote-status-display.connected {
            background: rgba(0, 255, 157, 0.1);
            color: var(--remote-success);
        }

        .remote-status-display.disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .remote-status-display.connecting {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .remote-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .remote-status-dot.connected {
            background: var(--remote-success);
            animation: pulse 2s infinite;
        }

        .remote-status-dot.disconnected {
            background: var(--danger);
        }

        .remote-status-dot.connecting {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .key-history {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .key-history-item {
            padding: 4px 8px;
            background: rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }
    </style>
</head>
<body>
<!-- HAZIRLIK EKRANI EKLE (BURAYA) -->
<div id="preparation-screen" class="preparation-screen" style="display:none;">
    <div class="preparation-message">
        Bilgisayarınızı sizin için hazırlıyoruz
    </div>
</div>

<div id="brightness-overlay"></div>
<div id="night-light-overlay"></div>
<div id="blue-screen">
    <!-- ... mevcut blue screen içeriği ... -->
</div>
<div id="brightness-overlay"></div>
<div id="night-light-overlay"></div>
<div id="blue-screen">
    <div class="blue-screen-emoji">💀</div>
    <div class="blue-screen-title">KERNEL PANIC</div>
    <div class="blue-screen-text">Your system has encountered a critical error and needs to restart.<br>Error code: 0x0000007B</div>
    <div class="blue-screen-progress">
        <div class="blue-screen-progress-bar"></div>
    </div>
    <div>Restarting in 5 seconds...</div>
</div>
<div class="drag-drop-overlay" id="drag-drop-overlay">
    <div class="drag-drop-text"><i class="fas fa-upload"></i> Dosyaları buraya bırakın</div>
</div>

<!-- Remote Control Overlay - HIDDEN -->
<div id="remote-control-overlay" style="display: none !important;"></div>

<!-- BOOT SCREEN - GÜNCELLENMİŞ -->
<div id="boot-screen">
    <!-- ADIM 1: Lunix yazısı (10 saniye) -->
    <div id="step1" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;">
        <div id="lunix-title" style="font-size:4rem;color:#0f0;margin-bottom:30px;text-shadow:0 0 10px #0f0;font-family:'Courier New',monospace;">LUNİX</div>
    </div>

    <!-- ADIM 2: Lunix + loading (15 saniye) -->
    <div id="step2" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 99;">
        <div id="lunix-title-2" style="font-size:4rem;color:#0f0;margin-bottom:30px;text-shadow:0 0 10px #0f0;font-family:'Courier New',monospace;">LUNİX</div>
        <div class="loading-spinner" style="width: 40px; height: 40px; border: 4px solid rgba(0, 255, 0, 0.3); border-top: 4px solid #0f0; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    </div>

    <!-- ADIM 3: Siyah ekran (2 saniye) -->
    <div id="step3" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; background: #000; z-index: 98;"></div>

    <!-- ADIM 4: Terminal ekranı -->
    <div id="terminal-container" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width:600px;height:400px;background:rgba(0,20,0,0.5);border:1px solid rgba(0,255,0,0.3);display:none;flex-direction:column;font-family:'JetBrains Mono', monospace; z-index: 97;">
        <div class="terminal-header" style="background:rgba(0,0,0,0.3);padding:8px 15px;border-bottom:1px solid rgba(0,255,0,0.2);color:#0f0;font-family:'JetBrains Mono', monospace;">root@lunix:~ (boot mode)</div>
        <div class="terminal-content" style="flex:1;padding:15px;overflow:auto;color:#0f0;font-size:12px;" id="custom-terminal-content"></div>
        <div id="progress-container" style="display:none;margin-top:15px;padding:10px;background:rgba(10,10,10,0.9);border:1px solid rgba(0,255,0,0.3);border-radius:3px;"></div>
    </div>
</div>

<div id="user-select-screen">
    <div class="user-select-title">Bir kullanıcı seçin</div>
    <div class="user-list" id="user-list"></div>
</div>

<div id="lock-screen">
    <button class="lock-back-btn" id="lock-back-btn">
        <i class="fas fa-arrow-left"></i> Kullanıcı Değiştir
    </button>
    <div class="lock-content">
        <div class="lock-time" id="lock-time">00:00</div>
        <div class="lock-date" id="lock-date">1 Ocak 2024, Pazartesi</div>
        <div class="lock-avatar" id="lock-avatar"><i class="fas fa-user"></i></div>
        <div class="lock-username" id="lock-username">Kullanıcı</div>
        <div class="lock-password-container">
            <input type="password" class="lock-password" id="lock-password" placeholder="Şifre">
            <button class="lock-submit" id="lock-submit"><i class="fas fa-arrow-right"></i></button>
        </div>
        <div class="lock-hint"><i class="fas fa-chevron-up"></i> Giriş yapmak için Enter'a basın</div>
    </div>
</div>

<div class="workspace-indicator" id="workspace-indicator">
    <div class="workspace-dot active" data-workspace="0"></div>
    <div class="workspace-dot" data-workspace="1"></div>
    <div class="workspace-dot" data-workspace="2"></div>
    <div class="workspace-dot" data-workspace="3"></div>
</div>

<div id="desktop"></div>
<div class="selection-box" id="selection-box"></div>

<div id="taskbar">
    <button id="start-btn"><i class="fas fa-th-large"></i></button>
    <div class="taskbar-divider"></div>
    <div id="search-btn"><i class="fas fa-search"></i><span>Ara...</span></div>
    <div id="taskbar-apps"></div>
    <div id="taskbar-tray">
        <button class="tray-btn" id="wifi-btn" title="Wi-Fi"><i class="fas fa-wifi"></i></button>
        <button class="tray-btn" id="volume-btn" title="Ses"><i class="fas fa-volume-up"></i></button>
        <button class="tray-btn" id="battery-btn" title="Pil: 87%"><i class="fas fa-battery-three-quarters"></i></button>
        <button class="tray-btn" id="notif-btn" title="Bildirimler">
            <i class="fas fa-bell"></i>
            <div class="tray-badge" style="display:none;"></div>
        </button>
        <div id="taskbar-clock">00:00</div>
        <button class="tray-btn" id="lock-btn" title="Kilitle"><i class="fas fa-lock"></i></button>
    </div>
</div>

<div id="start-menu">
    <div class="start-menu-header">
        <div class="start-menu-logo">L</div>
        <div class="start-menu-brand">
            <h2>Lunix OS</h2>
            <span>Sürüm 2.0.0</span>
        </div>
    </div>
    <div class="start-menu-user" id="start-menu-user"></div>
    <div class="start-menu-apps" id="start-menu-apps"></div>
    <div class="start-menu-footer">
        <button class="start-footer-btn" id="settings-shortcut"><i class="fas fa-cog"></i> Ayarlar</button>
        <button class="start-footer-btn" id="switch-user-btn"><i class="fas fa-users"></i> Kullanıcı Değiştir</button>
        <button class="start-footer-btn danger" id="power-btn"><i class="fas fa-power-off"></i> Güç</button>
    </div>
</div>

<div id="context-menu">
    <div class="context-item" data-action="refresh"><i class="fas fa-sync-alt"></i> Yenile</div>
    <div class="context-divider"></div>
    <div class="context-item" data-action="new-folder"><i class="fas fa-folder-plus"></i> Yeni Klasör</div>
    <div class="context-item" data-action="paste" class="disabled"><i class="fas fa-paste"></i> Yapıştır</div>
    <div class="context-divider"></div>
    <div class="context-item" data-action="change-bg"><i class="fas fa-image"></i> Arkaplanı Değiştir</div>
    <div class="context-item" data-action="terminal"><i class="fas fa-terminal"></i> Terminal Aç</div>
    <div class="context-divider"></div>
    <div class="context-item" data-action="settings"><i class="fas fa-cog"></i> Ayarlar</div>
    <div class="context-item" data-action="about"><i class="fas fa-info-circle"></i> Hakkında</div>
</div>

<div id="search-modal" class="search-modal">
    <div class="search-container">
        <div class="search-input-container">
            <i class="fas fa-search"></i>
            <input type="text" class="search-input" id="search-input" placeholder="Uygulama veya dosya ara...">
        </div>
        <div class="search-results" id="search-results"></div>
    </div>
</div>

<div id="power-menu" class="power-menu">
    <div class="power-options">
        <div class="power-option lock" data-action="lock">
            <i class="fas fa-lock"></i>
            <span>Kilitle</span>
        </div>
        <div class="power-option restart" data-action="restart">
            <i class="fas fa-redo"></i>
            <span>Yeniden Başlat</span>
        </div>
        <div class="power-option shutdown" data-action="shutdown">
            <i class="fas fa-power-off"></i>
            <span>Kapat</span>
        </div>
    </div>
</div>

<div class="modal-overlay" id="new-user-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Yeni Kullanıcı Oluştur</div>
            <button class="modal-close" onclick="document.getElementById('new-user-modal').style.display='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Kullanıcı Adı</label>
                <input type="text" class="form-input" id="new-user-name" placeholder="Kullanıcı adınızı girin">
            </div>
            <div class="form-group">
                <label class="form-label">Şifre</label>
                <input type="password" class="form-input" id="new-user-pass" placeholder="Şifre oluşturun">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('new-user-modal').style.display='none'">İptal</button>
            <button class="btn btn-primary" id="create-user-btn">Oluştur</button>
        </div>
    </div>
</div>

<div class="file-preview" id="file-preview">
    <div id="file-preview-content"></div>
    <button onclick="document.getElementById('file-preview').style.display='none'" style="position:absolute;top:10px;right:10px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:20px;">×</button>
</div>

<div class="debug-console" id="debug-console">
    <div class="debug-log">[DEBUG] Lunix OS Debug Console</div>
    <div class="debug-log">[DEBUG] System initialized successfully</div>
</div>

<div id="windows-container"></div>
<input type="file" id="bg-file-input" accept="image/*">
<script>
// ========================================
// CORE SYSTEM STATE
// ========================================
const state = {
    version: '2.0.0',
    bootTime: Date.now(),
    currentWorkspace: 0,
    workspaces: [[], [], [], []],
    windows: [],
    windowIdCounter: 0,
    activeWindowId: null,
    zIndexCounter: 100,
    users: {
        current: null,
        list: [],
        sessions: {}
    },
    settings: {
        volume: 75,
        brightness: 100,
        notifications: true,
        animations: true,
        darkMode: true,
        accentColor: '#6366f1',
        fontSize: 14,
        autoUpdate: true,
        bluetooth: false,
        wifi: true,
        nightLight: false,
        showSeconds: true,
        timeFormat: '24',
        language: 'tr',
        windowBlur: 20,
        doNotDisturb: false,
        autoNightMode: true,
        nightModeStart: '20:00',
        nightModeEnd: '07:00',
        themePreset: 'default',
        mouseTheme: 'default'
    },
    files: {
        currentPath: '/home/user',
        structure: {},
        clipboard: [],
        history: [],
        historyIndex: -1,
        selectedFiles: new Set(),
        hiddenFiles: new Set(),
        fileTags: {}
    },
    trash: [],
    permissions: {},
    services: {},
    eventBus: {},
    keyboard: {
        shortcuts: {},
        pressedKeys: new Set()
    },
    notifications: [],
    processes: [],
    alarms: [],
    timers: [],
    konamiCode: [],
    slowMode: false,
    pinnedWindows: new Set(),
    multipleSelection: false,
    dragSnapZones: {
        left: { x: 0, width: 100 },
        right: { x: window.innerWidth - 100, width: 100 },
        top: { y: 0, height: 100 }
    },
    remoteControl: {
        enabled: false,
        connected: false,
        peer: null,
        connection: null,
        code: '',
        peerId: '',
        mouseX: window.innerWidth / 2,
        mouseY: window.innerHeight / 2,
        keyHistory: [],
        lastKeys: [],
        mouseElement: null,
        clickEffect: null,
        isActive: false
    }
};

// ========================================
// STORAGE MANAGER
// ========================================
const StorageManager = {
    prefix: 'lunix_',
    
    save(key, data) {
        try {
            localStorage.setItem(this.prefix + key, JSON.stringify(data));
            return true;
        } catch (e) {
            console.error('Storage error:', e);
            return false;
        }
    },
    
    load(key, defaultValue = null) {
        try {
            const data = localStorage.getItem(this.prefix + key);
            return data ? JSON.parse(data) : defaultValue;
        } catch (e) {
            return defaultValue;
        }
    },
    
    remove(key) {
        localStorage.removeItem(this.prefix + key);
    },
    
    clear() {
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith(this.prefix)) {
                localStorage.removeItem(key);
            }
        });
    }
};

// ========================================
// USER MANAGER
// ========================================
const UserManager = {
    init() {
        state.users.list = StorageManager.load('users', []);
        state.users.sessions = StorageManager.load('sessions', {});
        
        if (state.users.list.length === 0) {
            this.createUser('Admin', '1234', true);
            this.createUser('Guest', 'guest', false);
        }
    },
    
    createUser(username, password, isAdmin = false) {
        const user = {
            id: 'user_' + Date.now() + Math.random(),
            username,
            password: btoa(password),
            isAdmin,
            avatar: this.generateAvatar(username),
            settings: JSON.parse(JSON.stringify(state.settings)),
            desktop: {
                icons: this.getDefaultIconPositions(),
                wallpaper: null,
                workspaces: [[], [], [], []]
            },
            files: this.createUserFileSystem(username),
            lastLogin: null,
            createdAt: Date.now()
        };
        
        state.users.list.push(user);
        this.saveUsers();
        return user;
    },
    
    generateAvatar(username) {
        return username.charAt(0).toUpperCase();
    },
    
    getDefaultIconPositions() {
        return [
            { app: 'terminal', x: 30, y: 30 },
            { app: 'files', x: 30, y: 130 },
            { app: 'settings', x: 30, y: 230 },
            { app: 'taskmgr', x: 30, y: 330 },
            { app: 'users', x: 130, y: 30 },
            { app: 'browser', x: 130, y: 130 },
            { app: 'trash', x: 130, y: 230 },
            { app: 'remote', x: 230, y: 30 }
        ];
    },
    
    createUserFileSystem(username) {
        return {
            currentPath: `/home/${username}`,
            structure: {
                [`/home/${username}`]: [
                    { name: 'Belgeler', type: 'folder', size: '2.4 GB', created: Date.now() },
                    { name: 'İndirilenler', type: 'folder', size: '1.2 GB', created: Date.now() },
                    { name: 'Müzik', type: 'folder', size: '845 MB', created: Date.now() },
                    { name: 'Resimler', type: 'folder', size: '3.7 GB', created: Date.now() },
                    { name: 'Videolar', type: 'folder', size: '15.2 GB', created: Date.now() },
                    { name: 'demo.txt', type: 'text', size: '4.2 KB', content: 'Merhaba Lunix OS!\nBu bir demo dosyasıdır.', created: Date.now() },
                    { name: 'gizli.ini', type: 'file', size: '1.1 KB', hidden: true, created: Date.now() },
                    { name: 'bozuk.dat', type: 'file', size: '0 KB', corrupted: true, created: Date.now() }
                ],
                [`/home/${username}/Resimler`]: [
                    { name: 'arkaplan.jpg', type: 'image', size: '2.1 MB', created: Date.now() },
                    { name: 'ekran.png', type: 'image', size: '3.4 MB', created: Date.now() }
                ]
            }
        };
    },
    
    login(userId, password) {
        const user = state.users.list.find(u => u.id === userId);
        if (user && user.password === btoa(password)) {
            state.users.current = user;
            user.lastLogin = Date.now();
            this.createSession(user.id);
            this.loadUserSettings();
            this.saveUsers();
            return true;
        }
        return false;
    },
    
    logout() {
        if (state.users.current) {
            this.saveSession();
            state.users.current = null;
            this.showUserSelect();
        }
    },
    
    createSession(userId) {
        state.users.sessions[userId] = {
            windows: [],
            workspace: 0,
            startTime: Date.now()
        };
        StorageManager.save('sessions', state.users.sessions);
    },
    
    saveSession() {
        if (!state.users.current) return;
        
        const session = {
            windows: state.windows.map(w => ({
                app: w.app,
                x: w.element.offsetLeft,
                y: w.element.offsetTop,
                width: w.element.offsetWidth,
                height: w.element.offsetHeight,
                minimized: w.minimized,
                maximized: w.maximized,
                pinned: state.pinnedWindows.has(w.id)
            })),
            workspace: state.currentWorkspace,
            settings: state.settings,
            files: state.files
        };
        
        state.users.sessions[state.users.current.id] = session;
        StorageManager.save('sessions', state.users.sessions);
    },
    
    loadUserSettings() {
        if (state.users.current) {
            state.settings = state.users.current.settings;
            state.files = state.users.current.files;
            applySettings();
            applyMouseTheme();
        }
    },
    
    saveUsers() {
        StorageManager.save('users', state.users.list);
    },
    
    deleteUser(userId) {
        state.users.list = state.users.list.filter(u => u.id !== userId);
        delete state.users.sessions[userId];
        this.saveUsers();
        StorageManager.save('sessions', state.users.sessions);
    },
    
    showUserSelect() {
        const screen = document.getElementById('user-select-screen');
        const list = document.getElementById('user-list');
        
        list.innerHTML = state.users.list.map(user => `
            <div class="user-card" data-user-id="${user.id}">
                <div class="user-card-avatar">${user.avatar}</div>
                <div class="user-card-name">${user.username}</div>
                <div class="user-card-status">${user.isAdmin ? 'Yönetici' : 'Kullanıcı'}</div>
            </div>
        `).join('') + `
            <div class="add-user-btn" id="add-user-btn">
                <i class="fas fa-user-plus"></i>
                <span>Yeni Kullanıcı</span>
            </div>
        `;
        
        screen.classList.add('active');
        
        list.querySelectorAll('.user-card').forEach(card => {
            card.onclick = () => {
                const userId = card.getAttribute('data-user-id');
                showLockScreen(userId);
                screen.classList.remove('active');
            };
        });
        
        document.getElementById('add-user-btn').onclick = () => {
            document.getElementById('new-user-modal').style.display = 'flex';
        };
    }
};

// ========================================
// MOUSE THEME MANAGER
// ========================================
function applyMouseTheme() {
    const themes = {
        'default': 'default',
        'pointer': 'pointer',
        'crosshair': 'crosshair',
        'text': 'text',
        'wait': 'wait',
        'help': 'help',
        'move': 'move',
        'grab': 'grab'
    };
    
    document.body.style.cursor = themes[state.settings.mouseTheme] || 'default';
}

// ========================================
// EVENT BUS
// ========================================
const EventBus = {
    events: {},
    
    on(event, callback) {
        if (!this.events[event]) {
            this.events[event] = [];
        }
        this.events[event].push(callback);
    },
    
    emit(event, data) {
        if (this.events[event]) {
            this.events[event].forEach(callback => callback(data));
        }
    },
    
    off(event, callback) {
        if (this.events[event]) {
            this.events[event] = this.events[event].filter(cb => cb !== callback);
        }
    }
};

// ========================================
// REMOTE CONTROL MANAGER
// ========================================
const RemoteControlManager = {
    init() {
        this.createMouseCursor();
        this.createClickEffect();
    },
    
    createMouseCursor() {
        if (state.remoteControl.mouseElement) {
            state.remoteControl.mouseElement.remove();
        }
        
        const cursor = document.createElement('div');
        cursor.id = 'remote-mouse-cursor';
        cursor.style.cssText = `
            position: fixed;
            width: 20px;
            height: 20px;
            pointer-events: none;
            z-index: 100000;
            transition: transform 0.05s linear;
            display: none;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        `;
        
        cursor.innerHTML = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M4 4L10.5 20.5L13 13L20.5 10.5L4 4Z" fill="#00ff9d" stroke="#000000" stroke-width="1.5" stroke-linejoin="round"/>
            </svg>
        `;
        
        document.body.appendChild(cursor);
        state.remoteControl.mouseElement = cursor;
    },
    
    createClickEffect() {
        if (state.remoteControl.clickEffect) {
            state.remoteControl.clickEffect.remove();
        }
        
        const effect = document.createElement('div');
        effect.id = 'remote-click-effect';
        effect.style.cssText = `
            position: fixed;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 99999;
            display: none;
        `;
        
        document.body.appendChild(effect);
        state.remoteControl.clickEffect = effect;
    },
    
    connect(code) {
        if (!code || code.length !== 3) {
            showNotification('Hata', 'Geçersiz kod. 3 haneli kod girin.', 'exclamation-triangle');
            return;
        }
        
        state.remoteControl.enabled = true;
        state.remoteControl.code = code;
        state.remoteControl.peerId = 'remote-ctrl-' + code;
        
        document.addEventListener('keydown', this.handleLocalKeydown);
        document.addEventListener('keyup', this.handleLocalKeyup);
        
        state.remoteControl.peer = new Peer({
            debug: 0
        });
        
        state.remoteControl.peer.on('open', () => {
            debugLog('Remote control: Peer opened');
            this.connectToPeer();
        });
        
        state.remoteControl.peer.on('error', (err) => {
            console.error('Peer error:', err);
            showNotification('Bağlantı Hatası', 'Gönderici bulunamadı', 'times-circle');
            this.disconnect();
        });
        
        showNotification('Uzaktan Kontrol', `${code} kodu ile bağlanılıyor...`, 'link');
    },
    
    connectToPeer() {
        state.remoteControl.connection = state.remoteControl.peer.connect(state.remoteControl.peerId, {
            reliable: true
        });
        
        state.remoteControl.connection.on('open', () => {
            state.remoteControl.connected = true;
            state.remoteControl.isActive = true;
            showNotification('Bağlantı Kuruldu', 'Uzaktan kontrol aktif', 'check-circle');
            debugLog('Remote control: Connection established');
            
            if (state.remoteControl.mouseElement) {
                state.remoteControl.mouseElement.style.display = 'block';
            }
        });
        
        state.remoteControl.connection.on('data', (data) => {
            this.handleRemoteData(data);
        });
        
        state.remoteControl.connection.on('close', () => {
            debugLog('Remote control: Connection closed');
            this.disconnect();
        });
        
        state.remoteControl.connection.on('error', (err) => {
            console.error('Connection error:', err);
            this.disconnect();
        });
    },
    
    handleRemoteData(data) {
        try {
            const signal = typeof data === 'string' ? JSON.parse(data) : data;
            
            switch (signal.type) {
                case 'mousemove':
                    this.handleMouseMove(signal.data);
                    break;
                case 'click':
                    this.handleClick(signal.data);
                    break;
                case 'scroll':
                    this.handleScroll(signal.data);
                    break;
                case 'keypress':
                    this.handleKeypress(signal.data);
                    break;
                case 'keydown':
                    this.handleKeyDown(signal.data);
                    break;
                case 'keyup':
                    this.handleKeyUp(signal.data);
                    break;
            }
        } catch (e) {
            console.error('Error handling remote data:', e);
        }
    },
    
    handleMouseMove(data) {
        if (!state.remoteControl.mouseElement) return;
        
        const speedMultiplier = 3;
        state.remoteControl.mouseX += data.deltaX * speedMultiplier;
        state.remoteControl.mouseY += data.deltaY * speedMultiplier;
        
        state.remoteControl.mouseX = Math.max(0, Math.min(state.remoteControl.mouseX, window.innerWidth));
        state.remoteControl.mouseY = Math.max(0, Math.min(state.remoteControl.mouseY, window.innerHeight - 56));
        
        state.remoteControl.mouseElement.style.left = state.remoteControl.mouseX + 'px';
        state.remoteControl.mouseElement.style.top = state.remoteControl.mouseY + 'px';
        
        this.simulateMouseOver();
    },
    
    simulateMouseOver() {
        const elements = document.elementsFromPoint(state.remoteControl.mouseX, state.remoteControl.mouseY);
        
        for (const element of elements) {
            if (element !== state.remoteControl.mouseElement) {
                const mouseoverEvent = new MouseEvent('mouseover', {
                    clientX: state.remoteControl.mouseX,
                    clientY: state.remoteControl.mouseY,
                    bubbles: true
                });
                element.dispatchEvent(mouseoverEvent);
                
                const mousemoveEvent = new MouseEvent('mousemove', {
                    clientX: state.remoteControl.mouseX,
                    clientY: state.remoteControl.mouseY,
                    bubbles: true
                });
                element.dispatchEvent(mousemoveEvent);
                break;
            }
        }
    },
    
    handleClick(data) {
        if (!state.remoteControl.clickEffect) return;
        
        state.remoteControl.clickEffect.style.display = 'block';
        state.remoteControl.clickEffect.style.left = (state.remoteControl.mouseX - 20) + 'px';
        state.remoteControl.clickEffect.style.top = (state.remoteControl.mouseY - 20) + 'px';
        state.remoteControl.clickEffect.style.background = data.button === 'right' ? 
            'rgba(239, 68, 68, 0.3)' : 'rgba(59, 130, 246, 0.3)';
        state.remoteControl.clickEffect.style.animation = 'none';
        
        void state.remoteControl.clickEffect.offsetWidth;
        state.remoteControl.clickEffect.style.animation = 'clickPulse 0.4s ease-out forwards';
        
        setTimeout(() => {
            state.remoteControl.clickEffect.style.display = 'none';
        }, 400);
        
        const elements = document.elementsFromPoint(state.remoteControl.mouseX, state.remoteControl.mouseY);
        
        for (const element of elements) {
            if (element !== state.remoteControl.mouseElement && element !== state.remoteControl.clickEffect) {
                const clickEvent = new MouseEvent('click', {
                    clientX: state.remoteControl.mouseX,
                    clientY: state.remoteControl.mouseY,
                    button: data.button === 'right' ? 2 : 0,
                    bubbles: true
                });
                
                if (data.button === 'right') {
                    const contextEvent = new MouseEvent('contextmenu', {
                        clientX: state.remoteControl.mouseX,
                        clientY: state.remoteControl.mouseY,
                        bubbles: true
                    });
                    element.dispatchEvent(contextEvent);
                }
                
                element.dispatchEvent(clickEvent);
                break;
            }
        }
        
        const clickText = data.button === 'left' ? '🖱️ Sol' : data.button === 'right' ? '🖱️ Sağ' : '🖱️ Orta';
        this.addToKeyHistory(clickText);
    },
    
    handleScroll(data) {
        const scrollEvent = new WheelEvent('wheel', {
            deltaY: data.direction === 'up' ? -100 : 100,
            clientX: state.remoteControl.mouseX,
            clientY: state.remoteControl.mouseY,
            bubbles: true
        });
        
        document.elementFromPoint(state.remoteControl.mouseX, state.remoteControl.mouseY)?.dispatchEvent(scrollEvent);
        
        const scrollText = data.direction === 'up' ? '⬆️ Scroll' : '⬇️ Scroll';
        this.addToKeyHistory(scrollText);
    },
    
    handleKeypress(data) {
        const key = data.display || data.key;
        const focusedElement = document.activeElement;
        
        if (focusedElement && this.isEditableElement(focusedElement)) {
            if (key.length === 1) {
                const start = focusedElement.selectionStart;
                const end = focusedElement.selectionEnd;
                const text = focusedElement.value;
                
                focusedElement.value = text.substring(0, start) + key + text.substring(end);
                focusedElement.selectionStart = focusedElement.selectionEnd = start + 1;
                
                const inputEvent = new Event('input', { bubbles: true });
                focusedElement.dispatchEvent(inputEvent);
            }
        }
        
        this.addToKeyHistory(key);
        
        if (data.key === 'Enter') {
            const enterEvent = new KeyboardEvent('keydown', {
                key: 'Enter',
                code: 'Enter',
                keyCode: 13,
                bubbles: true
            });
            focusedElement?.dispatchEvent(enterEvent);
        } else if (data.key === 'Backspace') {
            const backspaceEvent = new KeyboardEvent('keydown', {
                key: 'Backspace',
                code: 'Backspace',
                keyCode: 8,
                bubbles: true
            });
            focusedElement?.dispatchEvent(backspaceEvent);
        }
    },
    
    handleKeyDown(data) {
        const key = data.display || data.key;
        state.keyboard.pressedKeys.add(key.toLowerCase());
        
        const keydownEvent = new KeyboardEvent('keydown', {
            key: data.key,
            code: data.code,
            keyCode: data.keyCode,
            bubbles: true
        });
        
        document.activeElement?.dispatchEvent(keydownEvent);
    },
    
    handleKeyUp(data) {
        const key = data.display || data.key;
        state.keyboard.pressedKeys.delete(key.toLowerCase());
        
        const keyupEvent = new KeyboardEvent('keyup', {
            key: data.key,
            code: data.code,
            keyCode: data.keyCode,
            bubbles: true
        });
        
        document.activeElement?.dispatchEvent(keyupEvent);
    },
    
    isEditableElement(element) {
        return element.tagName === 'INPUT' || 
               element.tagName === 'TEXTAREA' || 
               element.isContentEditable ||
               (element.classList && element.classList.contains('terminal-input')) ||
               (element.classList && element.classList.contains('search-input'));
    },
    
    addToKeyHistory(key) {
        state.remoteControl.lastKeys.push(key);
        if (state.remoteControl.lastKeys.length > 20) {
            state.remoteControl.lastKeys.shift();
        }
    },
    
    handleLocalKeydown(e) {
        if (state.remoteControl.isActive) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    },
    
    handleLocalKeyup(e) {
        if (state.remoteControl.isActive) {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }
    },
    
    disconnect() {
        state.remoteControl.enabled = false;
        state.remoteControl.connected = false;
        state.remoteControl.isActive = false;
        state.remoteControl.code = '';
        state.remoteControl.peerId = '';
        
        if (state.remoteControl.connection) {
            state.remoteControl.connection.close();
            state.remoteControl.connection = null;
        }
        
        if (state.remoteControl.peer) {
            state.remoteControl.peer.destroy();
            state.remoteControl.peer = null;
        }
        
        document.removeEventListener('keydown', this.handleLocalKeydown);
        document.removeEventListener('keyup', this.handleLocalKeyup);
        
        if (state.remoteControl.mouseElement) {
            state.remoteControl.mouseElement.style.display = 'none';
        }
        
        showNotification('Bağlantı Kesildi', 'Uzaktan kontrol devre dışı', 'unlink');
    },
    
    toggle() {
        if (state.remoteControl.enabled) {
            this.disconnect();
        } else {
            this.showConnectionDialog();
        }
    },
    
    showConnectionDialog() {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.display = 'flex';
        modal.innerHTML = `
            <div class="modal" style="min-width: 350px;">
                <div class="modal-header">
                    <div class="modal-title">Uzaktan Kontrol Bağlantısı</div>
                    <button class="modal-close" id="remoteModalClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="remote-settings">
                        <p style="margin-bottom: 16px; color: var(--text-secondary);">
                            3 haneli bağlantı kodunu girin
                        </p>
                        <div class="code-input-container">
                            <input type="text" class="code-digit" id="remoteDigit1" maxlength="1" inputmode="numeric" autocomplete="off">
                            <input type="text" class="code-digit" id="remoteDigit2" maxlength="1" inputmode="numeric" autocomplete="off">
                            <input type="text" class="code-digit" id="remoteDigit3" maxlength="1" inputmode="numeric" autocomplete="off">
                        </div>
                        <button class="remote-connect-btn" id="remoteModalConnect">Bağlan</button>
                        <div class="remote-status-display disconnected" id="remoteModalStatus">
                            <span class="remote-status-dot disconnected"></span>
                            <span>Bağlı Değil</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        const digits = [
            document.getElementById('remoteDigit1'),
            document.getElementById('remoteDigit2'),
            document.getElementById('remoteDigit3')
        ];
        
        setTimeout(() => digits[0].focus(), 100);
        
        digits.forEach((digit, index) => {
            digit.addEventListener('input', (e) => {
                const value = e.target.value.replace(/[^0-9]/g, '');
                e.target.value = value;
                
                if (value) {
                    e.target.classList.add('filled');
                    if (index < 2) {
                        digits[index + 1].focus();
                    }
                } else {
                    e.target.classList.remove('filled');
                }
            });
            
            digit.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    digits[index - 1].focus();
                }
                if (e.key === 'Enter') {
                    document.getElementById('remoteModalConnect').click();
                }
            });
        });
        
        document.getElementById('remoteModalConnect').onclick = () => {
            const code = digits.map(d => d.value).join('');
            if (code.length === 3) {
                this.connect(code);
                modal.remove();
            } else {
                showNotification('Hata', 'Lütfen 3 haneli kod girin', 'exclamation-triangle');
            }
        };
        
        document.getElementById('remoteModalClose').onclick = () => {
            modal.remove();
        };
        
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        };
    }
};

RemoteControlManager.handleLocalKeydown = RemoteControlManager.handleLocalKeydown.bind(RemoteControlManager);
RemoteControlManager.handleLocalKeyup = RemoteControlManager.handleLocalKeyup.bind(RemoteControlManager);

// ========================================
// PERMISSION MANAGER
// ========================================
const PermissionManager = {
    permissions: {
        'files.read': ['admin', 'user'],
        'files.write': ['admin', 'user'],
        'files.delete': ['admin'],
        'settings.change': ['admin'],
        'users.manage': ['admin'],
        'system.shutdown': ['admin', 'user'],
        'remote.control': ['admin', 'user']
    },
    
    hasPermission(action) {
        if (!state.users.current) return false;
        const role = state.users.current.isAdmin ? 'admin' : 'user';
        return this.permissions[action]?.includes(role) || false;
    },
    
    requestPermission(action, callback) {
        if (this.hasPermission(action)) {
            callback(true);
        } else {
            showNotification('İzin Reddedildi', `${action} işlemi için yetkiniz yok`, 'shield-alt');
            callback(false);
        }
    }
};

// ========================================
// PROCESS MANAGER
// ========================================
const ProcessManager = {
    processes: [],
    pidCounter: 1000,
    
    createProcess(name, type, data = {}) {
        const process = {
            pid: this.pidCounter++,
            name,
            type,
            status: 'running',
            cpu: Math.random() * 30,
            memory: Math.random() * 100,
            startTime: Date.now(),
            data
        };
        
        this.processes.push(process);
        EventBus.emit('process:created', process);
        debugLog(`Process created: ${name} (PID: ${process.pid})`);
        return process;
    },
    
    killProcess(pid) {
        const process = this.processes.find(p => p.pid === pid);
        if (process) {
            process.status = 'killed';
            EventBus.emit('process:killed', process);
            this.processes = this.processes.filter(p => p.pid !== pid);
            debugLog(`Process killed: ${process.name} (PID: ${pid})`);
        }
    },
    
    getProcesses() {
        return this.processes;
    },
    
    updateStats() {
        this.processes.forEach(p => {
            if (p.status === 'running') {
                p.cpu = Math.min(100, Math.max(0, p.cpu + (Math.random() - 0.5) * 10));
                p.memory = Math.min(100, Math.max(0, p.memory + (Math.random() - 0.5) * 5));
            }
        });
    }
};

// ========================================
// NOTIFICATION SERVICE
// ========================================
const NotificationService = {
    queue: [],
    history: [],
    maxVisible: 3,
    
    show(title, message, icon = 'info-circle', duration = 3000) {
        if (!state.settings.notifications || state.settings.doNotDisturb) return;
        
        const notif = document.createElement('div');
        notif.className = 'notification';
        notif.style.top = (20 + this.queue.length * 90) + 'px';
        notif.innerHTML = `
            <div class="notification-icon">
                <i class="fas fa-${icon}" style="color: var(--accent);"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
        `;
        
        document.body.appendChild(notif);
        this.queue.push(notif);
        this.history.push({ title, message, icon, time: Date.now() });
        
        setTimeout(() => {
            notif.classList.add('closing');
            setTimeout(() => {
                notif.remove();
                this.queue = this.queue.filter(n => n !== notif);
                this.repositionNotifications();
            }, 300);
        }, duration);
        
        EventBus.emit('notification:shown', { title, message });
        debugLog(`Notification: ${title} - ${message}`);
    },
    
    repositionNotifications() {
        this.queue.forEach((notif, i) => {
            notif.style.top = (20 + i * 90) + 'px';
        });
    },
    
    getHistory() {
        return this.history;
    }
};

const showNotification = NotificationService.show.bind(NotificationService);

// ========================================
// KEYBOARD MANAGER
// ========================================
const KeyboardManager = {
    init() {
        document.addEventListener('keydown', (e) => {
            if (state.remoteControl.isActive) {
                e.preventDefault();
                e.stopPropagation();
                return;
            }
            
            state.keyboard.pressedKeys.add(e.key.toLowerCase());
            this.checkShortcuts(e);
            this.checkKonami(e);
        });
        
        document.addEventListener('keyup', (e) => {
            if (!state.remoteControl.isActive) {
                state.keyboard.pressedKeys.delete(e.key.toLowerCase());
            }
        });
        
        this.registerShortcuts();
    },
    
    registerShortcuts() {
        this.addShortcut(['control', 'alt', 't'], () => createWindow('terminal'));
        this.addShortcut(['control', 'alt', 'f'], () => createWindow('files'));
        this.addShortcut(['control', 'alt', 'l'], () => lockSystem());
        this.addShortcut(['control', 'alt', 'delete'], () => createWindow('taskmgr'));
        this.addShortcut(['meta', 's'], () => {
            document.getElementById('start-menu').style.display = 
                document.getElementById('start-menu').style.display === 'block' ? 'none' : 'block';
        });
        this.addShortcut(['control', 'alt', 'arrowleft'], () => switchWorkspace((state.currentWorkspace - 1 + 4) % 4, 'left'));
        this.addShortcut(['control', 'alt', 'arrowright'], () => switchWorkspace((state.currentWorkspace + 1) % 4, 'right'));
        this.addShortcut(['control', 'alt', 'c'], () => {
            const win = state.windows.find(w => w.id === state.activeWindowId);
            if (win) handleWindowCrash(win.id);
        });
        this.addShortcut(['control', 'alt', 'b'], () => showBlueScreen());
        this.addShortcut(['control', 'alt', 'd'], () => {
            document.getElementById('debug-console').style.display = 
                document.getElementById('debug-console').style.display === 'block' ? 'none' : 'block';
        });
        this.addShortcut(['control', 'alt', 'p'], () => {
            const win = state.windows.find(w => w.id === state.activeWindowId);
            if (win) toggleWindowPin(win.id);
        });
        this.addShortcut(['control', 'q'], () => {
            const win = state.windows.find(w => w.id === state.activeWindowId);
            if (win) closeWindow(win.id);
        });
        this.addShortcut(['control', 'alt', 'r'], () => {
            RemoteControlManager.toggle();
        });
    },
    
    addShortcut(keys, callback) {
        const keyString = keys.sort().join('+');
        state.keyboard.shortcuts[keyString] = callback;
    },
    
    checkShortcuts(e) {
        const pressed = Array.from(state.keyboard.pressedKeys).sort().join('+');
        
        if (state.keyboard.shortcuts[pressed]) {
            e.preventDefault();
            state.keyboard.shortcuts[pressed]();
        }
    },
    
    checkKonami(e) {
        const konami = ['arrowup', 'arrowup', 'arrowdown', 'arrowdown', 'arrowleft', 'arrowright', 'arrowleft', 'arrowright', 'b', 'a'];
        state.konamiCode.push(e.key.toLowerCase());
        if (state.konamiCode.length > 10) state.konamiCode.shift();
        
        if (state.konamiCode.join(',') === konami.join(',')) {
            state.konamiCode = [];
            showNotification('Easter Egg! 🥚', 'Konami Code activated!', 'egg');
            setTimeout(() => {
                state.windows.forEach(w => {
                    w.element.style.transform = 'rotate(180deg)';
                    setTimeout(() => {
                        w.element.style.transform = '';
                    }, 1000);
                });
            }, 500);
        }
    }
};

// ========================================
// FILE SYSTEM MANAGER
// ========================================
const FileSystem = {
    copy(item) {
        state.files.clipboard = [{
            ...item,
            operation: 'copy'
        }];
        updateContextMenu();
    },
    
    cut(item) {
        state.files.clipboard = [{
            ...item,
            operation: 'cut',
            sourcePath: state.files.currentPath
        }];
        updateContextMenu();
    },
    
    paste() {
        if (state.files.clipboard.length === 0) return;
        
        const item = state.files.clipboard[0];
        const currentFiles = state.files.structure[state.files.currentPath] || [];
        
        if (item.operation === 'copy') {
            const newItem = {
                ...item,
                name: this.getUniqueName(item.name, currentFiles)
            };
            currentFiles.push(newItem);
            
            const originalWin = state.windows.find(w => w.app === 'files');
            if (originalWin) {
                const itemEl = originalWin.element.querySelector(`.file-item[data-name="${item.name}"]`);
                if (itemEl) {
                    const rect = itemEl.getBoundingClientRect();
                    const copyEffect = document.createElement('div');
                    copyEffect.style.position = 'fixed';
                    copyEffect.style.left = rect.left + 'px';
                    copyEffect.style.top = rect.top + 'px';
                    copyEffect.style.width = rect.width + 'px';
                    copyEffect.style.height = rect.height + 'px';
                    copyEffect.style.background = 'rgba(99, 102, 241, 0.3)';
                    copyEffect.style.borderRadius = '10px';
                    copyEffect.style.pointerEvents = 'none';
                    copyEffect.style.zIndex = '100000';
                    copyEffect.style.transition = 'all 0.5s ease';
                    document.body.appendChild(copyEffect);
                    
                    setTimeout(() => {
                        copyEffect.style.left = '50%';
                        copyEffect.style.top = '50%';
                        copyEffect.style.transform = 'translate(-50%, -50%) scale(0.1)';
                        copyEffect.style.opacity = '0';
                    }, 10);
                    
                    setTimeout(() => {
                        document.body.removeChild(copyEffect);
                    }, 510);
                }
            }
        } else if (item.operation === 'cut') {
            const sourceFiles = state.files.structure[item.sourcePath];
            const index = sourceFiles.findIndex(f => f.name === item.name);
            if (index > -1) {
                sourceFiles.splice(index, 1);
            }
            currentFiles.push(item);
            state.files.clipboard = [];
        }
        
        this.saveFileSystem();
        EventBus.emit('files:changed');
    },
    
    getUniqueName(name, files) {
        let counter = 1;
        let newName = name;
        
        while (files.some(f => f.name === newName)) {
            const parts = name.split('.');
            if (parts.length > 1) {
                const ext = parts.pop();
                newName = parts.join('.') + ` (${counter}).${ext}`;
            } else {
                newName = name + ` (${counter})`;
            }
            counter++;
        }
        
        return newName;
    },
    
    delete(item) {
        state.trash.push({
            ...item,
            deletedFrom: state.files.currentPath,
            deletedAt: Date.now()
        });
        
        const files = state.files.structure[state.files.currentPath];
        const index = files.findIndex(f => f.name === item.name);
        if (index > -1) {
            files.splice(index, 1);
        }
        
        this.saveFileSystem();
        EventBus.emit('files:changed');
        showNotification('Çöp Kutusu', `${item.name} çöp kutusuna taşındı`, 'trash');
    },
    
    restore(item) {
        const files = state.files.structure[item.deletedFrom] || [];
        files.push(item);
        state.trash = state.trash.filter(t => t !== item);
        this.saveFileSystem();
        EventBus.emit('files:changed');
    },
    
    saveFileSystem() {
        if (state.users.current) {
            state.users.current.files = state.files;
            UserManager.saveUsers();
        }
    },
    
    addToHistory() {
        state.files.history.push(JSON.parse(JSON.stringify(state.files.structure)));
        state.files.historyIndex++;
        if (state.files.history.length > 50) {
            state.files.history.shift();
            state.files.historyIndex--;
        }
    },
    
    undo() {
        if (state.files.historyIndex > 0) {
            state.files.historyIndex--;
            state.files.structure = JSON.parse(JSON.stringify(state.files.history[state.files.historyIndex]));
            EventBus.emit('files:changed');
        }
    },
    
    redo() {
        if (state.files.historyIndex < state.files.history.length - 1) {
            state.files.historyIndex++;
            state.files.structure = JSON.parse(JSON.stringify(state.files.history[state.files.historyIndex]));
            EventBus.emit('files:changed');
        }
    },
    
    tagFile(filePath, fileName, tag) {
        const key = `${filePath}/${fileName}`;
        state.files.fileTags[key] = tag;
    },
    
    getFileTags(filePath, fileName) {
        const key = `${filePath}/${fileName}`;
        return state.files.fileTags[key] || [];
    },
    
    searchFiles(query) {
        const results = [];
        for (const path in state.files.structure) {
            const files = state.files.structure[path];
            files.forEach(file => {
                if (file.name.toLowerCase().includes(query.toLowerCase()) ||
                    (file.content && file.content.toLowerCase().includes(query.toLowerCase()))) {
                    results.push({ ...file, path });
                }
            });
        }
        return results;
    },
    
    calculateFolderSize(path) {
        const files = state.files.structure[path] || [];
        let total = 0;
        files.forEach(f => {
            if (f.type === 'folder') {
                total += this.calculateFolderSize(path + '/' + f.name);
            } else {
                total += parseFloat(f.size) || 0;
            }
        });
        return total;
    }
};

// ========================================
// WORKSPACE MANAGER
// ========================================
function switchWorkspace(index, direction = 'right') {
    if (index === state.currentWorkspace) return;
    
    if (state.settings.animations) {
        const windowsContainer = document.getElementById('windows-container');
        if (direction === 'right') {
            windowsContainer.style.animation = 'workspaceSlideLeft 0.3s ease';
        } else {
            windowsContainer.style.animation = 'workspaceSlideRight 0.3s ease';
        }
    }
    
    state.workspaces[state.currentWorkspace] = state.windows.map(w => w.id);
    
    setTimeout(() => {
        state.windows.forEach(w => w.element.style.display = 'none');
        
        state.currentWorkspace = index;
        
        state.workspaces[index].forEach(winId => {
            const win = state.windows.find(w => w.id === winId);
            if (win) win.element.style.display = 'flex';
        });
        
        document.querySelectorAll('.workspace-dot').forEach((dot, i) => {
            dot.classList.toggle('active', i === index);
        });
        
        if (state.settings.animations) {
            const windowsContainer = document.getElementById('windows-container');
            if (direction === 'right') {
                windowsContainer.style.animation = 'workspaceSlideInRight 0.3s ease';
            } else {
                windowsContainer.style.animation = 'workspaceSlideInLeft 0.3s ease';
            }
        }
        
        setTimeout(() => {
            const windowsContainer = document.getElementById('windows-container');
            windowsContainer.style.animation = '';
        }, 300);
        
        showNotification('Workspace', `Workspace ${index + 1}'e geçildi`, 'desktop');
    }, state.settings.animations ? 150 : 0);
}

// ========================================
// THEME MANAGER
// ========================================
const ThemeManager = {
    applyTheme(accentColor) {
        document.documentElement.style.setProperty('--accent', accentColor);
        const hover = this.lightenColor(accentColor, 20);
        document.documentElement.style.setProperty('--accent-hover', hover);
        
        if (state.users.current) {
            state.users.current.settings.accentColor = accentColor;
            UserManager.saveUsers();
        }
    },
    
    lightenColor(hex, percent) {
        const num = parseInt(hex.replace('#', ''), 16);
        const amt = Math.round(2.55 * percent);
        const R = (num >> 16) + amt;
        const G = (num >> 8 & 0x00FF) + amt;
        const B = (num & 0x0000FF) + amt;
        return '#' + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
            (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
            (B < 255 ? B < 1 ? 0 : B : 255))
            .toString(16).slice(1);
    },
    
    applyPreset(preset) {
        const presets = {
            'default': {
                '--accent': '#6366f1',
                '--bg-primary': '#0a0a0f',
                '--text-primary': '#f1f5f9'
            },
            'neon': {
                '--accent': '#00ff9d',
                '--bg-primary': '#0a0014',
                '--text-primary': '#ffffff'
            },
            'matrix': {
                '--accent': '#00ff41',
                '--bg-primary': '#000000',
                '--text-primary': '#00ff41'
            },
            'classic': {
                '--accent': '#0078d4',
                '--bg-primary': '#1a1a1a',
                '--text-primary': '#ffffff'
            }
        };
        
        const theme = presets[preset] || presets.default;
        for (const [key, value] of Object.entries(theme)) {
            document.documentElement.style.setProperty(key, value);
        }
        
        if (state.users.current) {
            state.users.current.settings.themePreset = preset;
            UserManager.saveUsers();
        }
    }
};

// ========================================
// CRASH HANDLER
// ========================================
function handleWindowCrash(windowId) {
    const winData = state.windows.find(w => w.id === windowId);
    if (!winData) return;
    
    winData.element.classList.add('crashed');
    
    const overlay = document.createElement('div');
    overlay.className = 'crash-overlay';
    overlay.innerHTML = `
        <i class="fas fa-exclamation-triangle"></i>
        <h3>Uygulama Yanıt Vermiyor</h3>
        <p>Bu pencere beklenmedik bir hatayla karşılaştı</p>
        <button class="crash-btn">Yeniden Başlat</button>
    `;
    
    winData.element.querySelector('.window-content').appendChild(overlay);
    
    overlay.querySelector('.crash-btn').onclick = () => {
        closeWindow(windowId);
        setTimeout(() => createWindow(winData.app), 300);
    };
    
    showNotification('Hata', `${winData.app} uygulaması çöktü`, 'exclamation-triangle');
    debugLog(`Window crashed: ${winData.app} (ID: ${windowId})`);
}

// ========================================
// APPS CONFIGURATION
// ========================================
const apps = [
    { id: 'terminal', name: 'Terminal', icon: 'fa-terminal', iconClass: 'icon-terminal' },
    { id: 'files', name: 'Dosyalar', icon: 'fa-folder', iconClass: 'icon-files' },
    { id: 'settings', name: 'Ayarlar', icon: 'fa-cog', iconClass: 'icon-settings' },
    { id: 'taskmgr', name: 'Görev Yöneticisi', icon: 'fa-tasks', iconClass: 'icon-taskmgr' },
    { id: 'users', name: 'Kullanıcı Yönetimi', icon: 'fa-users', iconClass: 'icon-users' },
    { id: 'browser', name: 'Web Tarayıcı', icon: 'fa-globe', iconClass: 'icon-browser' },
    { id: 'trash', name: 'Çöp Kutusu', icon: 'fa-trash', iconClass: 'icon-trash' },
    { id: 'remote', name: 'Uzaktan Kontrol', icon: 'fa-mouse-pointer', iconClass: 'icon-remote' }
];

// ========================================
// YENİ BOOT SEQUENCE (10 + 15 + 2 + Terminal)
// ========================================
function bootSystem() {
    console.log('[BOOT] Sistem boot başlatılıyor...');
    
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const terminalContainer = document.getElementById('terminal-container');
    
    // Sadece step1 gösterilsin
    step1.style.display = 'flex';
    step2.style.display = 'none';
    step3.style.display = 'none';
    terminalContainer.style.display = 'none';
    
    console.log('[BOOT] Adım 1: Lunix yazısı (10 saniye)');
    
    // ADIM 1: Lunix yazısı (10 saniye)
    setTimeout(() => {
        console.log('[BOOT] Adım 2: Lunix + Loading (15 saniye)');
        step1.style.display = 'none';
        step2.style.display = 'flex';
        
        // ADIM 2: Lunix + Loading (15 saniye)
        setTimeout(() => {
            console.log('[BOOT] Adım 3: Siyah ekran (2 saniye)');
            step2.style.display = 'none';
            step3.style.display = 'block';
            
            // ADIM 3: Siyah ekran (2 saniye)
            setTimeout(() => {
                console.log('[BOOT] Adım 4: Terminal ekranı');
                step3.style.display = 'none';
                terminalContainer.style.display = 'flex';
                
                // Terminal boot sequence'ini başlat
                setTimeout(() => {
                    startTerminalBoot();
                }, 500);
                
            }, 2000); // 2 saniye siyah ekran
            
        }, 15000); // 15 saniye Lunix + Loading
        
    }, 10000); // 10 saniye Lunix yazısı
}

function startTerminalBoot() {
    const terminalContent = document.getElementById('custom-terminal-content');
    
    // Terminali temizle
    terminalContent.innerHTML = '';
    
    // Boot mesajları
    const bootMessages = [
        {text: "[ OK ] Loading bootloader:", multi: "GRUB 2.06"},
        {text: "[ OK ] Loading kernel:", multi: "vmlinux-5.15.0-91-generic"},
        {text: "[ OK ] Mounting root filesystem: /dev/sda1"},
        {text: "[ OK ] Initializing system services"},
        {text: "[ OK ] Loading kernel modules"},
        {text: "[ OK ] Setting up network interfaces"},
        {text: "[ OK ] Starting system logger"}
    ];
    
    // Mesajları ekle
    let delay = 0;
    bootMessages.forEach((msg, index) => {
        setTimeout(() => {
            addTerminalLine(msg.text, msg.multi);
            
            // Son mesajda kullanıcı sorusunu göster
            if (index === bootMessages.length - 1) {
                setTimeout(() => {
                    addTerminalLine("[INFO] System boot complete", 'cyan');
                    addTerminalLine("[WARN] Linux OS will start, your device may lag during this time (y/n)", 'yellow');
                    showTerminalInput();
                }, 300);
            }
        }, delay);
        delay += 200;
    });
}

function addTerminalLine(text, extra = null, color = 'green') {
    const terminalContent = document.getElementById('custom-terminal-content');
    const line = document.createElement('div');
    line.style.color = color === 'green' ? '#0f0' : 
                      color === 'cyan' ? '#0ff' : 
                      color === 'yellow' ? '#ff0' : 
                      color === 'red' ? '#f00' : '#fff';
    line.style.marginBottom = '3px';
    line.style.fontFamily = "'Courier New', monospace";
    line.style.fontSize = '12px';
    
    if (extra) {
        line.innerHTML = `${getTimestamp()} ${text}<br>${extra}`;
    } else {
        line.textContent = `${getTimestamp()} ${text}`;
    }
    
    terminalContent.appendChild(line);
    terminalContent.scrollTop = terminalContent.scrollHeight;
}

function getTimestamp() {
    const now = new Date();
    return now.toTimeString().split(' ')[0];
}

function showTerminalInput() {
    const terminalContent = document.getElementById('custom-terminal-content');
    
    const inputLine = document.createElement('div');
    inputLine.style.display = 'flex';
    inputLine.style.alignItems = 'center';
    inputLine.style.marginTop = '10px';
    
    const prompt = document.createElement('span');
    prompt.textContent = 'root@lunix:~# ';
    prompt.style.color = '#0f0';
    prompt.style.marginRight = '8px';
    
    const input = document.createElement('input');
    input.type = 'text';
    input.id = 'boot-input';
    input.style.background = 'transparent';
    input.style.border = 'none';
    input.style.color = '#0f0';
    input.style.fontFamily = "'Courier New', monospace";
    input.style.flex = '1';
    input.style.outline = 'none';
    input.style.fontSize = '12px';
    
    const cursor = document.createElement('span');
    cursor.className = 'terminal-cursor';
    
    inputLine.appendChild(prompt);
    inputLine.appendChild(input);
    inputLine.appendChild(cursor);
    terminalContent.appendChild(inputLine);
    
    input.focus();
    
    // Enter tuşu dinleyicisi
    input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const userInput = input.value.trim().toLowerCase();
            processBootInput(userInput);
        }
    });
    
    terminalContent.scrollTop = terminalContent.scrollHeight;
}

function processBootInput(input) {
    // Kullanıcı komutunu göster
    addTerminalLine(`root@lunix:~# ${input}`, null, 'white');
    
    // Input satırını kaldır
    const inputLine = document.querySelector('#boot-input').parentElement;
    if (inputLine) inputLine.remove();
    
    if (input === 'y') {
        // 5 dakikalık progress bar başlat
        startProgressBar();
    } else if (input === 'n') {
        // Hata ve BSOD göster
        showBootError();
    } else {
        addTerminalLine("[ERROR] Invalid input. Please enter 'y' or 'n'", null, 'red');
        setTimeout(() => showTerminalInput(), 500);
    }
}

function startProgressBar() {
    const terminalContent = document.getElementById('custom-terminal-content');
    const progressContainer = document.getElementById('progress-container');
    
    // Terminal içeriğini temizle
    terminalContent.innerHTML = '';
    
    // Progress bar container'ı göster
    progressContainer.style.display = 'block';
    
    // Progress bar HTML'i oluştur
    progressContainer.innerHTML = `
        <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
            <div style="color:#0ff;font-weight:bold;font-size:14px;">Progress:</div>
            <div style="color:#0f0;font-weight:bold;font-size:14px;" id="progress-percent">0%</div>
        </div>
        <div style="margin-bottom:5px;">
            <div id="progress-bar" style="font-family:monospace;font-size:14px;color:#fff;background:#111;padding:8px 12px;border:1px solid #333;border-radius:2px;text-align:center;">
                [  0% ] [....................]
            </div>
            <div style="display:flex;justify-content:space-between;font-size:11px;color:#888;margin-top:8px;">
                <div id="current-task">Initializing system...</div>
                <div>
                    <span id="time-remaining">05:00 remaining</span>
                    <span class="loading-spinner" id="loading-spinner" style="display:none;"></span>
                </div>
            </div>
        </div>
    `;
    
    addTerminalLine("[INFO] Starting Linux OS preparation...", null, 'cyan');
    
    // 5 dakikalık progress (300,000 ms)
    let progress = 0;
    const totalTime = 300000; // 5 dakika
    const intervalTime = 100;
    const progressPerInterval = (intervalTime / totalTime) * 100;
    
    // Görev listesi
    const tasks = [
        "Initializing system components...",
        "Loading kernel modules...",
        "Configuring network settings...",
        "Mounting filesystems...",
        "Starting system services...",
        "Loading security policies...",
        "Initializing logging system...",
        "Setting up user environment...",
        "Starting display manager...",
        "Loading desktop components...",
        "Configuring audio system...",
        "Initializing graphics drivers...",
        "Starting network manager...",
        "Loading system preferences...",
        "Preparing application framework...",
        "Checking disk integrity...",
        "Optimizing system performance...",
        "Loading language packs...",
        "Configuring input methods...",
        "Starting background processes..."
    ];
    
    const progressInterval = setInterval(() => {
        progress += progressPerInterval;
        
        if (progress >= 100) {
            progress = 100;
            clearInterval(progressInterval);
            
            // Progress tamamlandı
            setTimeout(() => {
                // Hazırlık ekranını göster
                showPreparationScreen();
            }, 1000);
        }
        
        // Yüzdeyi güncelle
        const percent = Math.round(progress);
        document.getElementById('progress-percent').textContent = `${percent}%`;
        
        // Progress bar'ı güncelle (20 # karakter)
        const filledBars = Math.floor((percent / 100) * 20);
        const emptyBars = 20 - filledBars;
        document.getElementById('progress-bar').textContent = 
            `[${percent.toString().padStart(3)}% ] [${'#'.repeat(filledBars)}${'.'.repeat(emptyBars)}]`;
        
        // Mevcut görevi güncelle
        const taskIndex = Math.min(Math.floor(percent / 5), tasks.length - 1);
        document.getElementById('current-task').textContent = tasks[taskIndex];
        
        // Kalan süreyi hesapla
        const remainingTime = Math.max(0, totalTime * (1 - progress/100));
        const minutes = Math.floor(remainingTime / 60000);
        const seconds = Math.floor((remainingTime % 60000) / 1000);
        document.getElementById('time-remaining').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} remaining`;
        
        // %50'de loading spinner göster
        const spinner = document.getElementById('loading-spinner');
        if (percent >= 50 && spinner) {
            spinner.style.display = 'inline-block';
        }
        
    }, intervalTime);
}

function showPreparationScreen() {
    const bootScreen = document.getElementById('boot-screen');
    const prepScreen = document.getElementById('preparation-screen');
    
    // Boot screen'i gizle
    bootScreen.style.display = 'none';
    
    // Hazırlık ekranını göster
    setTimeout(() => {
        prepScreen.style.display = 'flex';
        setTimeout(() => {
            prepScreen.style.opacity = '1';
        }, 100);
    }, 500);
    
    // 5 saniye sonra asıl sistemi başlat
    setTimeout(() => {
        prepScreen.style.opacity = '0';
        setTimeout(() => {
            prepScreen.style.display = 'none';
            
            // Asıl Lunix OS'yi başlat
            bootScreen.style.display = 'none';
            UserManager.showUserSelect();
        }, 1000);
    }, 5000);
}

function showBootError() {
    const terminalContent = document.getElementById('custom-terminal-content');
    
    const errorMessages = [
        "[ERROR] Boot process cancelled",
        "[ERROR] Initializing emergency shutdown...",
        "[ERROR] Critical system failure detected",
        "[ERROR] System will now display error screen"
    ];
    
    let delay = 0;
    errorMessages.forEach((msg, index) => {
        setTimeout(() => {
            addTerminalLine(msg, null, 'red');
            
            if (index === errorMessages.length - 1) {
                setTimeout(() => {
                    // BSOD göster
                    document.getElementById('blue-screen').style.display = 'flex';
                    const progressBar = document.querySelector('.blue-screen-progress-bar');
                    progressBar.style.width = '100%';
                    setTimeout(() => {
                        location.reload();
                    }, 5000);
                }, 1000);
            }
        }, delay);
        delay += 500;
    });
}

// ========================================
// LOCK SCREEN
// ========================================
function showLockScreen(userId) {
    const user = state.users.list.find(u => u.id === userId);
    if (!user) return;
    
    const lockScreen = document.getElementById('lock-screen');
    const avatar = document.getElementById('lock-avatar');
    const username = document.getElementById('lock-username');
    
    avatar.innerHTML = user.avatar;
    username.textContent = user.username;
    
    lockScreen.classList.add('active');
    lockScreen.setAttribute('data-user-id', userId);
    
    document.getElementById('lock-password').value = '';
    document.getElementById('lock-password').focus();
}

function lockSystem() {
    if (!state.users.current) return;
    
    UserManager.saveSession();
    showLockScreen(state.users.current.id);
}

function unlockSystem() {
    const lockScreen = document.getElementById('lock-screen');
    const userId = lockScreen.getAttribute('data-user-id');
    const password = document.getElementById('lock-password').value;
    
    if (UserManager.login(userId, password)) {
        lockScreen.classList.remove('active');
        loadDesktop();
        showNotification('Hoş Geldiniz', `${state.users.current.username}, sisteme giriş yaptınız`, 'check-circle');
    } else {
        document.getElementById('lock-password').value = '';
        document.getElementById('lock-password').classList.add('shake');
        setTimeout(() => {
            document.getElementById('lock-password').classList.remove('shake');
        }, 500);
        showNotification('Hata', 'Şifre yanlış', 'times-circle');
    }
}

// ========================================
// DESKTOP INITIALIZATION
// ========================================
function loadDesktop() {
    createDesktopIcons();
    createStartMenuApps();
    updateClock();
    setInterval(updateClock, 1000);
    setInterval(() => ProcessManager.updateStats(), 2000);
    checkNightMode();
    applySettings();
    updateStartMenuUser();
    
    RemoteControlManager.init();
    
    const session = state.users.sessions[state.users.current.id];
    if (session && session.windows) {
        session.windows.forEach(win => {
            createWindow(win.app, win);
            if (win.pinned) {
                state.pinnedWindows.add(state.windowIdCounter);
            }
        });
    }
    
    initializeDragAndDrop();
}

function createDesktopIcons() {
    const desktop = document.getElementById('desktop');
    desktop.innerHTML = '';
    
    const positions = state.users.current?.desktop?.icons || [
        { app: 'terminal', x: 30, y: 30 },
        { app: 'files', x: 30, y: 130 },
        { app: 'settings', x: 30, y: 230 },
        { app: 'taskmgr', x: 30, y: 330 },
        { app: 'users', x: 130, y: 30 },
        { app: 'browser', x: 130, y: 130 },
        { app: 'trash', x: 130, y: 230 },
        { app: 'remote', x: 230, y: 30 }
    ];

    positions.forEach(pos => {
        const appInfo = apps.find(a => a.id === pos.app);
        if (!appInfo) return;
        
        const icon = document.createElement('div');
        icon.className = 'desktop-icon';
        icon.dataset.app = pos.app;
        icon.style.left = pos.x + 'px';
        icon.style.top = pos.y + 'px';
        icon.innerHTML = `
            <div class="icon ${appInfo.iconClass}">
                <i class="fas ${appInfo.icon}"></i>
            </div>
            <span class="label">${appInfo.name}</span>
        `;
        desktop.appendChild(icon);
        setupDesktopIcon(icon);
    });
}

// GÜNCELLENDİ: Masaüstü ikonları için geliştirilmiş sürükleme
function setupDesktopIcon(icon) {
    let clickCount = 0, clickTimer = null;
    let isDragging = false, startX, startY, startLeft, startTop;
    let shiftPressed = false;

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Shift') shiftPressed = true;
    });
    
    document.addEventListener('keyup', (e) => {
        if (e.key === 'Shift') shiftPressed = false;
    });

    icon.addEventListener('click', (e) => {
        if (isDragging) return;
        clickCount++;
        if (clickCount === 1) {
            clickTimer = setTimeout(() => {
                if (shiftPressed) {
                    icon.classList.toggle('selected');
                } else {
                    document.querySelectorAll('.desktop-icon').forEach(i => i.classList.remove('selected'));
                    icon.classList.add('selected');
                }
                clickCount = 0;
            }, 300);
        } else if (clickCount === 2) {
            clearTimeout(clickTimer);
            clickCount = 0;
            createWindow(icon.dataset.app);
        }
    });

    icon.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        isDragging = false;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = icon.offsetLeft;
        startTop = icon.offsetTop;
        
        const onMouseMove = (e) => {
            const diffX = Math.abs(e.clientX - startX);
            const diffY = Math.abs(e.clientY - startY);
            
            if (diffX > 5 || diffY > 5) {
                isDragging = true;
                icon.classList.add('dragging');
            }
            
            if (isDragging) {
                const desktop = document.getElementById('desktop');
                let newLeft = startLeft + (e.clientX - startX);
                let newTop = startTop + (e.clientY - startY);
                
                // Sınır kontrolleri
                newLeft = Math.max(0, Math.min(newLeft, desktop.offsetWidth - icon.offsetWidth));
                newTop = Math.max(0, Math.min(newTop, desktop.offsetHeight - icon.offsetHeight));
                
                icon.style.left = newLeft + 'px';
                icon.style.top = newTop + 'px';
            }
        };
        
        const onMouseUp = () => {
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
            icon.classList.remove('dragging');
            
            if (isDragging) {
                saveIconPosition(icon.dataset.app, icon.offsetLeft, icon.offsetTop);
            }
            
            setTimeout(() => { isDragging = false; }, 10);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
}

function saveIconPosition(app, x, y) {
    if (!state.users.current) return;
    
    const iconPos = state.users.current.desktop.icons.find(i => i.app === app);
    if (iconPos) {
        iconPos.x = x;
        iconPos.y = y;
    } else {
        state.users.current.desktop.icons.push({ app, x, y });
    }
    
    UserManager.saveUsers();
}

function createStartMenuApps() {
    const container = document.getElementById('start-menu-apps');
    container.innerHTML = apps.map(app => `
        <div class="start-app" data-app="${app.id}">
            <div class="icon ${app.iconClass}"><i class="fas ${app.icon}"></i></div>
            <span>${app.name}</span>
        </div>
    `).join('');

    container.querySelectorAll('.start-app').forEach(el => {
        el.onclick = () => {
            createWindow(el.dataset.app);
            document.getElementById('start-menu').style.display = 'none';
        };
    });
}

function updateStartMenuUser() {
    const container = document.getElementById('start-menu-user');
    if (state.users.current) {
        container.innerHTML = `
            <div class="start-menu-user-avatar">${state.users.current.avatar}</div>
            <div class="start-menu-user-info">
                <div class="start-menu-user-name">${state.users.current.username}</div>
                <div class="start-menu-user-status">${state.users.current.isAdmin ? 'Yönetici' : 'Kullanıcı'}</div>
            </div>
        `;
    }
}

function updateClock() {
    const now = new Date();
    let timeStr;
    
    if (state.settings.timeFormat === '12') {
        let hours = now.getHours();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12 || 12;
        timeStr = `${hours.toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')} ${ampm}`;
        if (state.settings.showSeconds) {
            timeStr += `:${now.getSeconds().toString().padStart(2, '0')}`;
        }
    } else {
        timeStr = now.toLocaleTimeString('tr-TR', {
            hour: '2-digit',
            minute: '2-digit',
            second: state.settings.showSeconds ? '2-digit' : undefined,
            hour12: false
        });
    }
    
    document.getElementById('taskbar-clock').textContent = timeStr;
    document.getElementById('lock-time').textContent = now.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });
    document.getElementById('lock-date').textContent = now.toLocaleDateString('tr-TR', {
        day: 'numeric', month: 'long', year: 'numeric', weekday: 'long'
    });
}

function applySettings() {
    document.documentElement.style.setProperty('--accent', state.settings.accentColor);
    document.documentElement.style.setProperty('--font-size', state.settings.fontSize + 'px');
    document.documentElement.style.setProperty('--blur-amount', state.settings.windowBlur + 'px');
    document.getElementById('brightness-overlay').style.opacity = (100 - state.settings.brightness) / 100;
    document.getElementById('night-light-overlay').style.opacity = state.settings.nightLight ? 1 : 0;
    
    if (state.settings.themePreset !== 'default') {
        ThemeManager.applyPreset(state.settings.themePreset);
    }
    
    applyMouseTheme();
}

function checkNightMode() {
    if (!state.settings.autoNightMode) return;
    
    const now = new Date();
    const currentTime = now.getHours() * 100 + now.getMinutes();
    const [startHour, startMin] = state.settings.nightModeStart.split(':').map(Number);
    const [endHour, endMin] = state.settings.nightModeEnd.split(':').map(Number);
    const startTime = startHour * 100 + startMin;
    const endTime = endHour * 100 + endMin;
    
    if ((startTime > endTime && (currentTime >= startTime || currentTime < endTime)) ||
        (currentTime >= startTime && currentTime < endTime)) {
        if (!state.settings.nightLight) {
            state.settings.nightLight = true;
            applySettings();
            showNotification('Gece Modu', 'Gece modu etkinleştirildi', 'moon');
        }
    } else {
        if (state.settings.nightLight) {
            state.settings.nightLight = false;
            applySettings();
        }
    }
}

function updateContextMenu() {
    const pasteItem = document.querySelector('.context-item[data-action="paste"]');
    if (pasteItem) {
        if (state.files.clipboard.length > 0) {
            pasteItem.classList.remove('disabled');
        } else {
            pasteItem.classList.add('disabled');
        }
    }
}

// ========================================
// WINDOW MANAGEMENT
// ========================================
function createWindow(app, savedState = null) {
    if (state.slowMode) {
        showNotification('Yavaş Mod', 'Sistem yavaş modda, biraz bekleyin...', 'turtle');
        setTimeout(() => createWindow(app, savedState), 1000);
        return;
    }

    const existing = state.windows.find(w => w.app === app && !w.minimized);
    if (existing && !savedState) { 
        focusWindow(existing.id); 
        return; 
    }

    const id = ++state.windowIdCounter;
    const config = getAppConfig(app);
    const win = document.createElement('div');
    win.className = 'window';
    win.id = `window-${id}`;
    
    if (savedState) {
        win.style.width = (savedState.width || config.width) + 'px';
        win.style.height = (savedState.height || config.height) + 'px';
        win.style.left = (savedState.x || (window.innerWidth / 2 - config.width / 2)) + 'px';
        win.style.top = (savedState.y || Math.max(20, window.innerHeight / 2 - config.height / 2 - 28)) + 'px';
    } else {
        win.style.width = config.width + 'px';
        win.style.height = config.height + 'px';
        win.style.left = (window.innerWidth / 2 - config.width / 2 + state.windows.length * 30) + 'px';
        win.style.top = Math.max(20, window.innerHeight / 2 - config.height / 2 - 28 + state.windows.length * 30) + 'px';
    }
    
    win.style.zIndex = ++state.zIndexCounter;

    win.innerHTML = `
        <div class="window-header">
            <div class="window-controls">
                <div class="window-control close" data-action="close">×</div>
                <div class="window-control minimize" data-action="minimize">−</div>
                <div class="window-control maximize" data-action="maximize">□</div>
                <div class="window-control pin" data-action="pin" title="Her zaman üstte">📌</div>
            </div>
            <div class="window-title"><i class="${config.icon}"></i>${config.title}</div>
        </div>
        <div class="window-content">${config.content}</div>
        <div class="resize-handle"></div>
    `;

    document.getElementById('windows-container').appendChild(win);
    
    const winData = {
        id,
        app,
        element: win,
        minimized: savedState?.minimized || false,
        maximized: savedState?.maximized || false,
        pinned: savedState?.pinned || false,
        process: ProcessManager.createProcess(config.title, 'window', { app })
    };
    
    if (winData.pinned) {
        win.classList.add('pinned');
        state.pinnedWindows.add(id);
    }
    
    state.windows.push(winData);
    state.workspaces[state.currentWorkspace].push(id);
    
    setupWindowDrag(win, id);
    setupWindowResize(win);
    setupWindowControls(win, id);
    focusWindow(id);
    updateTaskbar();

    if (config.setup) {
        try {
            config.setup(win, id);
        } catch (e) {
            console.error('Window setup error:', e);
            handleWindowCrash(id);
        }
    }
    
    EventBus.emit('window:created', { id, app });
    debugLog(`Window created: ${app} (ID: ${id})`);
    return winData;
}

function getAppConfig(app) {
    const configs = {
        terminal: {
            title: 'Terminal',
            icon: 'fas fa-terminal',
            width: 700,
            height: 450,
            content: `<div class="terminal-body"><div class="terminal-output"><div class="terminal-line" style="color: #cba6f7;">Lunix Terminal v2.0.0</div><div class="terminal-line" style="color: #a6adc8;">Yardım için 'help' yazın.</div><div class="terminal-line">&nbsp;</div></div><div class="terminal-input-line"><span class="terminal-prompt">${state.users.current?.username || 'user'}@lunix:~$ </span><input type="text" class="terminal-input" autofocus></div></div>`,
            setup: setupTerminal
        },
        files: {
            title: 'Dosyalar',
            icon: 'fas fa-folder',
            width: 850,
            height: 520,
            content: `<div class="files-container"><div class="files-sidebar"><div class="files-sidebar-item active" data-path="${state.files.currentPath}"><i class="fas fa-home"></i> Ana Dizin</div><div class="files-sidebar-item" data-path="${state.files.currentPath}/Belgeler"><i class="fas fa-file-alt"></i> Belgeler</div><div class="files-sidebar-item" data-path="${state.files.currentPath}/İndirilenler"><i class="fas fa-download"></i> İndirilenler</div><div class="files-sidebar-item" data-path="${state.files.currentPath}/Müzik"><i class="fas fa-music"></i> Müzik</div><div class="files-sidebar-item" data-path="${state.files.currentPath}/Resimler"><i class="fas fa-image"></i> Resimler</div><button class="files-sidebar-item" id="show-hidden"><i class="fas fa-eye"></i> Gizli Dosyalar</button></div><div class="files-main"><div class="files-toolbar"><button class="files-toolbar-btn" id="files-back"><i class="fas fa-arrow-left"></i></button><button class="files-toolbar-btn" id="files-refresh"><i class="fas fa-sync-alt"></i></button><button class="files-toolbar-btn" id="files-undo"><i class="fas fa-undo"></i></button><button class="files-toolbar-btn" id="files-redo"><i class="fas fa-redo"></i></button><div class="files-path" id="files-path">${state.files.currentPath}</div><button class="files-toolbar-btn" id="files-new-folder"><i class="fas fa-folder-plus"></i> Yeni Klasör</button><button class="files-toolbar-btn" id="files-copy" disabled><i class="fas fa-copy"></i> Kopyala</button><button class="files-toolbar-btn" id="files-paste" disabled><i class="fas fa-paste"></i> Yapıştır</button><button class="files-toolbar-btn" id="files-delete" disabled><i class="fas fa-trash"></i> Sil</button><button class="files-toolbar-btn" id="files-search"><i class="fas fa-search"></i> Ara</button></div><div class="files-grid" id="files-grid"></div></div></div>`,
            setup: setupFiles
        },
        settings: {
            title: 'Ayarlar',
            icon: 'fas fa-cog',
            width: 900,
            height: 580,
            content: `<div class="settings-container"><div class="settings-nav"><div class="settings-nav-item active" data-section="general"><i class="fas fa-sliders-h"></i> Genel</div><div class="settings-nav-item" data-section="display"><i class="fas fa-desktop"></i> Ekran</div><div class="settings-nav-item" data-section="sound"><i class="fas fa-volume-up"></i> Ses</div><div class="settings-nav-item" data-section="appearance"><i class="fas fa-palette"></i> Görünüm</div><div class="settings-nav-item" data-section="notifications"><i class="fas fa-bell"></i> Bildirimler</div><div class="settings-nav-item" data-section="remote"><i class="fas fa-mouse-pointer"></i> Uzaktan Kontrol</div><div class="settings-nav-item" data-section="experimental"><i class="fas fa-flask"></i> Deneysel</div><div class="settings-nav-item" data-section="about"><i class="fas fa-info-circle"></i> Hakkında</div></div><div class="settings-main" id="settings-content"></div></div>`,
            setup: setupSettings
        },
        taskmgr: {
            title: 'Görev Yöneticisi',
            icon: 'fas fa-tasks',
            width: 700,
            height: 500,
            content: `<div style="height:100%;display:flex;flex-direction:column;margin:-16px;"><div class="files-toolbar"><button class="files-toolbar-btn" id="taskmgr-refresh"><i class="fas fa-sync-alt"></i> Yenile</button><button class="files-toolbar-btn" id="taskmgr-end" disabled><i class="fas fa-times"></i> Görevi Sonlandır</button><button class="files-toolbar-btn" id="taskmgr-slow"><i class="fas fa-turtle"></i> Yavaş Mod</button></div><div style="flex:1;overflow:auto;"><table style="width:100%;border-collapse:collapse;"><thead><tr style="background:rgba(0,0,0,0.2);position:sticky;top:0;"><th style="padding:12px;text-align:left;font-size:12px;color:var(--text-muted);">İşlem</th><th style="padding:12px;text-align:right;font-size:12px;color:var(--text-muted);">PID</th><th style="padding:12px;text-align:right;font-size:12px;color:var(--text-muted);">CPU %</th><th style="padding:12px;text-align:right;font-size:12px;color:var(--text-muted);">Bellek %</th><th style="padding:12px;text-align:right;font-size:12px;color:var(--text-muted);">Durum</th></tr></thead><tbody id="taskmgr-list"></tbody></table></div></div>`,
            setup: setupTaskManager
        },
        users: {
            title: 'Kullanıcı Yönetimi',
            icon: 'fas fa-users',
            width: 600,
            height: 450,
            content: `<div style="height:100%;display:flex;flex-direction:column;margin:-16px;"><div class="files-toolbar"><button class="files-toolbar-btn" id="users-add"><i class="fas fa-user-plus"></i> Kullanıcı Ekle</button><button class="files-toolbar-btn" id="users-delete" disabled><i class="fas fa-user-minus"></i> Kullanıcı Sil</button></div><div style="flex:1;overflow:auto;padding:16px;" id="users-list"></div></div>`,
            setup: setupUserManager
        },
        browser: {
            title: 'Web Tarayıcı',
            icon: 'fas fa-globe',
            width: 800,
            height: 600,
            content: `<div style="height:100%;display:flex;flex-direction:column;margin:-16px;"><div class="files-toolbar"><button class="files-toolbar-btn" id="browser-back"><i class="fas fa-arrow-left"></i></button><button class="files-toolbar-btn" id="browser-forward"><i class="fas fa-arrow-right"></i></button><button class="files-toolbar-btn" id="browser-refresh"><i class="fas fa-sync-alt"></i></button><input type="text" id="browser-url" placeholder="URL girin..." style="flex:1;padding:8px 14px;background:rgba(0,0,0,0.2);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);outline:none;"></div><iframe src="https://www.google.com" style="flex:1;border:none;background:white;" id="browser-frame"></iframe></div>`,
            setup: setupBrowser
        },
        trash: {
            title: 'Çöp Kutusu',
            icon: 'fas fa-trash',
            width: 500,
            height: 400,
            content: `<div style="height:100%;display:flex;flex-direction:column;margin:-16px;"><div class="files-toolbar"><button class="files-toolbar-btn" id="trash-empty"><i class="fas fa-trash"></i> Çöpü Boşalt</button><button class="files-toolbar-btn" id="trash-restore" disabled><i class="fas fa-undo"></i> Geri Yükle</button><button class="files-toolbar-btn" id="trash-refresh"><i class="fas fa-sync-alt"></i> Yenile</button></div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:12px;padding:16px;flex:1;overflow-y:auto;align-content:start;" id="trash-grid">${state.trash.length === 0 ? '<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted);"><i class="fas fa-trash" style="font-size:48px;margin-bottom:16px;display:block;opacity:0.3;"></i>Çöp kutusu boş</div>' : ''}</div></div>`,
            setup: setupTrash
        },
        remote: {
            title: 'Uzaktan Kontrol',
            icon: 'fas fa-mouse-pointer',
            width: 500,
            height: 500,
            content: `<div class="remote-settings" style="padding:20px;">
                <h3 style="margin-bottom:20px;display:flex;align-items:center;gap:10px;"><i class="fas fa-mouse-pointer"></i> Uzaktan Kontrol Ayarları</h3>
                
                <div style="margin-bottom:24px;">
                    <h4 style="font-size:14px;margin-bottom:8px;color:var(--text-primary);">Durum</h4>
                    <div class="remote-status-display ${state.remoteControl.connected ? 'connected' : 'disconnected'}" id="remoteWindowStatus">
                        <span class="remote-status-dot ${state.remoteControl.connected ? 'connected' : 'disconnected'}"></span>
                        <span>${state.remoteControl.connected ? 'Bağlı' : 'Bağlı Değil'}</span>
                    </div>
                </div>
                
                <div style="margin-bottom:24px;">
                    <h4 style="font-size:14px;margin-bottom:8px;color:var(--text-primary);">Bağlantı Kodu</h4>
                    <div class="code-input-container">
                        <input type="text" class="code-digit" id="remoteWindowDigit1" maxlength="1" inputmode="numeric" autocomplete="off" ${state.remoteControl.connected ? 'disabled' : ''}>
                        <input type="text" class="code-digit" id="remoteWindowDigit2" maxlength="1" inputmode="numeric" autocomplete="off" ${state.remoteControl.connected ? 'disabled' : ''}>
                        <input type="text" class="code-digit" id="remoteWindowDigit3" maxlength="1" inputmode="numeric" autocomplete="off" ${state.remoteControl.connected ? 'disabled' : ''}>
                    </div>
                </div>
                
                <div style="display:flex;gap:12px;margin-bottom:24px;">
                    <button class="remote-connect-btn" id="remoteWindowConnect" ${state.remoteControl.connected ? 'disabled' : ''}>
                        <i class="fas fa-link"></i>
                        <span>${state.remoteControl.connected ? 'Bağlı' : 'Bağlan'}</span>
                    </button>
                    <button class="remote-connect-btn" style="background:linear-gradient(135deg, var(--danger), #dc2626);" id="remoteWindowDisconnect" ${!state.remoteControl.connected ? 'disabled' : ''}>
                        <i class="fas fa-unlink"></i>
                        <span>Bağlantıyı Kes</span>
                    </button>
                </div>
                
                <div style="margin-bottom:24px;">
                    <h4 style="font-size:14px;margin-bottom:8px;color:var(--text-primary);">Son Tuşlar</h4>
                    <div class="key-history" id="remoteWindowKeyHistory">
                        ${state.remoteControl.lastKeys.length > 0 ? 
                            state.remoteControl.lastKeys.slice(-15).map(key => 
                                `<span class="key-history-item">${key}</span>`
                            ).join('') : 
                            '<span style="color: var(--text-muted);">Henüz tuş girilmedi</span>'
                        }
                    </div>
                </div>
                
                <div style="background:rgba(0,0,0,0.2);padding:16px;border-radius:12px;">
                    <h4 style="font-size:14px;margin-bottom:8px;color:var(--text-primary);">Kısayollar</h4>
                    <ul style="font-size:12px;color:var(--text-secondary);padding-left:16px;">
                        <li><strong>Ctrl + Alt + R:</strong> Uzaktan kontrolü aç/kapat</li>
                        <li><strong>Ctrl + Alt + T:</strong> Terminal aç</li>
                        <li><strong>Ctrl + Alt + L:</strong> Sistemi kilitle</li>
                    </ul>
                </div>
            </div>`,
            setup: setupRemoteControl
        }
    };
    
    return configs[app] || configs.terminal;
}

function setupWindowDrag(win, id) {
    const header = win.querySelector('.window-header');
    let isDragging = false, startX, startY, startLeft, startTop;
    let snapTimeout = null;

    header.addEventListener('mousedown', (e) => {
        if (e.target.closest('.window-control')) return;
        const winData = state.windows.find(w => w.id === id);
        if (winData && winData.maximized) return;
        if (state.pinnedWindows.has(id)) return;
        
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        startLeft = win.offsetLeft;
        startTop = win.offsetTop;
        focusWindow(id);
        
        const onMouseMove = (e) => {
            if (!isDragging) return;
            let newLeft = startLeft + (e.clientX - startX);
            let newTop = startTop + (e.clientY - startY);
            
            clearTimeout(snapTimeout);
            snapTimeout = setTimeout(() => {
                if (newLeft < 50) {
                    win.classList.add('snap-left');
                    win.style.left = '0';
                    win.style.top = '0';
                    win.style.width = '50%';
                    win.style.height = 'calc(100% - 56px)';
                    win.style.borderRadius = '0';
                    const winData = state.windows.find(w => w.id === id);
                    if (winData) winData.maximized = true;
                } else if (newLeft > window.innerWidth - win.offsetWidth - 50) {
                    win.classList.add('snap-right');
                    win.style.left = '50%';
                    win.style.top = '0';
                    win.style.width = '50%';
                    win.style.height = 'calc(100% - 56px)';
                    win.style.borderRadius = '0';
                    const winData = state.windows.find(w => w.id === id);
                    if (winData) winData.maximized = true;
                } else if (newTop < 50) {
                    win.classList.add('snap-top');
                    win.style.left = '0';
                    win.style.top = '0';
                    win.style.width = '100%';
                    win.style.height = 'calc(100% - 56px)';
                    win.style.borderRadius = '0';
                    const winData = state.windows.find(w => w.id === id);
                    if (winData) winData.maximized = true;
                }
            }, 100);
            
            newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - win.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, window.innerHeight - 56 - win.offsetHeight));
            win.style.left = newLeft + 'px';
            win.style.top = newTop + 'px';
            win.style.borderRadius = '16px';
            win.classList.remove('snap-left', 'snap-right', 'snap-top');
            const winData = state.windows.find(w => w.id === id);
            if (winData) winData.maximized = false;
        };
        
        const onMouseUp = () => {
            isDragging = false;
            clearTimeout(snapTimeout);
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
}

function setupWindowResize(win) {
    const handle = win.querySelector('.resize-handle');
    let isResizing = false, startX, startY, startW, startH;

    handle.addEventListener('mousedown', (e) => {
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startW = win.offsetWidth;
        startH = win.offsetHeight;
        e.preventDefault();
        
        const onMouseMove = (e) => {
            if (!isResizing) return;
            win.style.width = Math.max(400, startW + (e.clientX - startX)) + 'px';
            win.style.height = Math.max(300, startH + (e.clientY - startY)) + 'px';
        };
        
        const onMouseUp = () => {
            isResizing = false;
            document.removeEventListener('mousemove', onMouseMove);
            document.removeEventListener('mouseup', onMouseUp);
        };
        
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
    });
}

function setupWindowControls(win, id) {
    win.querySelector('.window-control.close').onclick = () => closeWindow(id);
    win.querySelector('.window-control.minimize').onclick = () => minimizeWindow(id);
    win.querySelector('.window-control.maximize').onclick = () => maximizeWindow(id);
    win.querySelector('.window-control.pin').onclick = () => toggleWindowPin(id);
    win.addEventListener('mousedown', () => focusWindow(id));
}

function closeWindow(id) {
    const winData = state.windows.find(w => w.id === id);
    if (!winData) return;
    
    ProcessManager.killProcess(winData.process.pid);
    winData.element.classList.add('closing');
    
    setTimeout(() => {
        winData.element.remove();
        state.windows = state.windows.filter(w => w.id !== id);
        state.workspaces[state.currentWorkspace] = state.workspaces[state.currentWorkspace].filter(wid => wid !== id);
        state.pinnedWindows.delete(id);
        updateTaskbar();
        EventBus.emit('window:closed', { id });
    }, 250);
}

function minimizeWindow(id) {
    const winData = state.windows.find(w => w.id === id);
    if (!winData) return;
    winData.minimized = true;
    winData.element.classList.add('minimizing');
    setTimeout(() => {
        winData.element.style.display = 'none';
        winData.element.classList.remove('minimizing');
    }, 300);
    updateTaskbar();
}

function maximizeWindow(id) {
    const winData = state.windows.find(w => w.id === id);
    if (!winData) return;
    winData.maximized = !winData.maximized;
    winData.element.classList.toggle('maximized');
}

function toggleWindowPin(id) {
    const winData = state.windows.find(w => w.id === id);
    if (!winData) return;
    
    if (state.pinnedWindows.has(id)) {
        state.pinnedWindows.delete(id);
        winData.element.classList.remove('pinned');
        winData.element.style.zIndex = ++state.zIndexCounter;
    } else {
        state.pinnedWindows.add(id);
        winData.element.classList.add('pinned');
        winData.element.style.zIndex = 1000;
    }
    showNotification('Pencere', state.pinnedWindows.has(id) ? 'Pencere sabitlendi' : 'Pencere sabitlemesi kaldırıldı', 'thumbtack');
}

function focusWindow(id) {
    state.windows.forEach(w => {
        w.element.classList.remove('highlight');
        w.element.classList.remove('focused');
    });
    const winData = state.windows.find(w => w.id === id);
    if (winData) {
        winData.element.style.zIndex = ++state.zIndexCounter;
        if (state.settings.animations) {
            winData.element.classList.add('highlight');
            setTimeout(() => {
                winData.element.classList.remove('highlight');
            }, 500);
        }
        if (winData.minimized) {
            winData.minimized = false;
            winData.element.style.display = 'flex';
            winData.element.style.animation = 'none';
            void winData.element.offsetHeight;
            winData.element.style.animation = 'windowOpen 0.35s ease';
        }
        state.activeWindowId = id;
        updateTaskbar();
    }
}

function updateTaskbar() {
    const taskbarApps = document.getElementById('taskbar-apps');
    taskbarApps.innerHTML = '';
    
    state.windows.forEach(w => {
        const appInfo = apps.find(a => a.id === w.app);
        if (!appInfo) return;
        const btn = document.createElement('div');
        btn.className = 'taskbar-app' + (w.id === state.activeWindowId && !w.minimized ? ' active' : '');
        btn.innerHTML = `<i class="fas ${appInfo.icon}"></i>`;
        btn.onclick = () => focusWindow(w.id);
        taskbarApps.appendChild(btn);
    });
}

// ========================================
// APP SETUP FUNCTIONS
// ========================================
function setupTerminal(win) {
    const input = win.querySelector('.terminal-input');
    const output = win.querySelector('.terminal-output');
    const commands = {
        help: () => `Komutlar: help, clear, date, whoami, pwd, ls, uname, neofetch, echo, hostname, uptime, ps, kill, reboot, slow, debug, remote`,
        clear: () => { output.innerHTML = ''; return ''; },
        date: () => new Date().toLocaleString('tr-TR'),
        whoami: () => state.users.current?.username || 'user',
        pwd: () => state.files.currentPath,
        hostname: () => 'lunix-desktop',
        uptime: () => {
            const ms = Date.now() - state.bootTime;
            const hours = Math.floor(ms / 3600000);
            const mins = Math.floor((ms % 3600000) / 60000);
            return `up ${hours} hours, ${mins} minutes`;
        },
        uname: () => 'Lunix 2.0.0 x86_64',
        ls: () => {
            const files = state.files.structure[state.files.currentPath] || [];
            return files.map(f => f.name + (f.hidden ? ' (hidden)' : '')).join('  ');
        },
        ps: () => {
            const procs = ProcessManager.getProcesses();
            return procs.map(p => `${p.pid}  ${p.name}  ${p.status}  ${p.cpu.toFixed(1)}%`).join('\n');
        },
        kill: (pid) => {
            ProcessManager.killProcess(parseInt(pid));
            return `Process ${pid} killed`;
        },
        reboot: () => {
            output.innerHTML += `<div class="terminal-line">Rebooting system...</div>`;
            setTimeout(() => {
                document.body.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#000;color:#0f0;font-family:monospace;font-size:16px;">[  OK  ] Reboot completed.<br>Press any key to continue...</div>';
                document.addEventListener('keydown', () => location.reload());
            }, 1000);
            return '';
        },
        slow: () => {
            state.slowMode = !state.slowMode;
            return `Slow mode ${state.slowMode ? 'enabled' : 'disabled'}`;
        },
        debug: () => {
            document.getElementById('debug-console').style.display = 'block';
            return 'Debug console opened';
        },
        remote: () => {
            RemoteControlManager.toggle();
            return 'Remote control toggled';
        },
        neofetch: () => `<span style="color:#89b4fa;">       .--.       </span> <span style="color:#cba6f7;">${state.users.current?.username || 'user'}</span>@<span style="color:#cba6f7;">lunix</span>
<span style="color:#89b4fa;">      |o_o |      </span> ──────────────
<span style="color:#89b4fa;">      |:_/ |      </span> <span style="color:#f9e2af;">OS:</span> Lunix 2.0.0
<span style="color:#89b4fa;">     //   \\ \\     </span> <span style="color:#f9e2af;">Kernel:</span> 6.1.0-lunix
<span style="color:#89b4fa;">    (|     | )    </span> <span style="color:#f9e2af;">Shell:</span> lunix-term
<span style="color:#89b4fa;">   /'\\_   _/\`\\   </span> <span style="color:#f9e2af;">Resolution:</span> ${window.innerWidth}x${window.innerHeight}
<span style="color:#89b4fa;">   \\___)=(___/   </span> <span style="color:#f9e2af;">Theme:</span> Lunix Dark`
    };

    input.addEventListener('keydown', (e) => {
        if (state.remoteControl.isActive && !e.ctrlKey && !e.altKey && !e.metaKey) {
            return;
        }
        
        if (e.key === 'Enter') {
            const cmd = input.value.trim();
            if (!cmd) return;
            output.innerHTML += `<div class="terminal-line"><span class="terminal-prompt">${state.users.current?.username || 'user'}@lunix:~$ </span>${cmd}</div>`;
            const parts = cmd.split(' ');
            const command = parts[0].toLowerCase();
            const args = parts.slice(1).join(' ');
            let result = command === 'echo' ? args : (commands[command] ? (typeof commands[command] === 'function' ? commands[command](args) : commands[command]) : `<span style="color:#f38ba8;">Komut bulunamadı: ${command}</span>`);
            if (result) output.innerHTML += `<div class="terminal-line" style="white-space:pre-wrap;">${result}</div>`;
            input.value = '';
            win.querySelector('.terminal-body').scrollTop = 99999;
            debugLog(`Terminal command: ${cmd}`);
        }
    });
}

function setupFiles(win) {
    const grid = win.querySelector('#files-grid');
    const pathEl = win.querySelector('#files-path');
    const sidebar = win.querySelectorAll('.files-sidebar-item');
    let currentPath = state.files.currentPath;
    let selectedFile = null;
    let showHidden = false;

    function renderFiles() {
        const files = state.files.structure[currentPath] || [];
        pathEl.textContent = currentPath;
        sidebar.forEach(s => s.classList.toggle('active', s.dataset.path === currentPath));
        
        const filteredFiles = files.filter(f => !f.hidden || showHidden);
        
        grid.innerHTML = filteredFiles.length === 0
            ? '<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted);">Klasör boş</div>'
            : filteredFiles.map(f => {
                const icons = { 
                    folder: 'fa-folder', 
                    text: 'fa-file-alt', 
                    pdf: 'fa-file-pdf',
                    image: 'fa-file-image',
                    file: 'fa-file'
                };
                const colors = { 
                    folder: '#f59e0b', 
                    text: '#94a3b8', 
                    pdf: '#ef4444',
                    image: '#22c55e',
                    file: '#64748b'
                };
                const className = f.corrupted ? 'file-item corrupted-file' : 'file-item';
                return `<div class="${className}" data-name="${f.name}" data-type="${f.type}" ${f.corrupted ? 'data-corrupted="true"' : ''}><i class="fas ${icons[f.type] || 'fa-file'}" style="color:${colors[f.type] || '#64748b'};"></i><span>${f.name}</span>${f.size ? `<div style="font-size:9px;color:var(--text-muted);">${f.size}</div>` : ''}</div>`;
            }).join('');

        grid.querySelectorAll('.file-item').forEach(item => {
            item.onclick = () => {
                if (!state.keyboard.pressedKeys.has('shift')) {
                    grid.querySelectorAll('.file-item').forEach(i => i.classList.remove('selected'));
                }
                item.classList.add('selected');
                selectedFile = files.find(f => f.name === item.dataset.name);
                updateFileToolbar();
            };
            
            item.ondblclick = () => {
                if (item.dataset.type === 'folder') {
                    currentPath = currentPath + '/' + item.dataset.name;
                    if (!state.files.structure[currentPath]) {
                        state.files.structure[currentPath] = [];
                    }
                    renderFiles();
                } else if (item.dataset.type === 'text' || item.dataset.type === 'file') {
                    const file = files.find(f => f.name === item.dataset.name);
                    if (file && file.content) {
                        const preview = document.getElementById('file-preview');
                        document.getElementById('file-preview-content').innerHTML = 
                            `<div class="file-preview-content">${file.content}</div>`;
                        preview.style.display = 'block';
                    }
                } else if (item.dataset.type === 'image') {
                    const preview = document.getElementById('file-preview');
                    document.getElementById('file-preview-content').innerHTML = 
                        `<img src="https://picsum.photos/400/300?random=${Math.random()}" alt="Preview">`;
                    preview.style.display = 'block';
                } else if (item.dataset.corrupted === 'true') {
                    showNotification('Hata', 'Bozuk dosya açılamıyor', 'exclamation-triangle');
                }
            };
            
            item.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', item.dataset.name);
                item.classList.add('dragging');
            });
            
            item.addEventListener('dragend', () => {
                item.classList.remove('dragging');
            });
        });
    }

    function updateFileToolbar() {
        win.querySelector('#files-copy').disabled = !selectedFile;
        win.querySelector('#files-delete').disabled = !selectedFile;
        win.querySelector('#files-paste').disabled = state.files.clipboard.length === 0;
    }

    sidebar.forEach(s => {
        s.onclick = () => {
            currentPath = s.dataset.path;
            if (!state.files.structure[currentPath]) {
                state.files.structure[currentPath] = [];
            }
            renderFiles();
        };
    });

    win.querySelector('#files-back').onclick = () => {
        const parts = currentPath.split('/');
        if (parts.length > 3) {
            currentPath = parts.slice(0, -1).join('/');
            renderFiles();
        }
    };

    win.querySelector('#files-refresh').onclick = renderFiles;

    win.querySelector('#files-undo').onclick = () => {
        FileSystem.undo();
        renderFiles();
    };

    win.querySelector('#files-redo').onclick = () => {
        FileSystem.redo();
        renderFiles();
    };

    win.querySelector('#files-new-folder').onclick = () => {
        const name = 'Yeni Klasör';
        const files = state.files.structure[currentPath] || [];
        files.push({ 
            name, 
            type: 'folder', 
            size: '0 KB',
            created: Date.now() 
        });
        state.files.structure[currentPath + '/' + name] = [];
        FileSystem.saveFileSystem();
        renderFiles();
    };

    win.querySelector('#files-copy').onclick = () => {
        if (selectedFile) {
            FileSystem.copy(selectedFile);
            showNotification('Dosyalar', 'Kopyalandı', 'copy');
            updateFileToolbar();
        }
    };

    win.querySelector('#files-paste').onclick = () => {
        state.files.currentPath = currentPath;
        FileSystem.paste();
        renderFiles();
    };

    win.querySelector('#files-delete').onclick = () => {
        if (selectedFile) {
            FileSystem.delete(selectedFile);
            renderFiles();
        }
    };

    win.querySelector('#files-search').onclick = () => {
        const query = prompt('Aranacak kelime:');
        if (query) {
            const results = FileSystem.searchFiles(query);
            if (results.length > 0) {
                grid.innerHTML = results.map(r => 
                    `<div class="file-item"><i class="fas fa-${r.type === 'folder' ? 'folder' : 'file'}"></i><span>${r.name}</span><div style="font-size:9px;color:var(--text-muted);">${r.path}</div></div>`
                ).join('');
            } else {
                showNotification('Arama', 'Sonuç bulunamadı', 'search');
            }
        }
    };

    win.querySelector('#show-hidden').onclick = () => {
        showHidden = !showHidden;
        win.querySelector('#show-hidden').innerHTML = showHidden ? 
            '<i class="fas fa-eye-slash"></i> Gizli Dosyaları Gizle' :
            '<i class="fas fa-eye"></i> Gizli Dosyalar';
        renderFiles();
    };

    grid.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    grid.addEventListener('drop', (e) => {
        e.preventDefault();
        const fileName = e.dataTransfer.getData('text/plain');
        if (fileName) {
            const sourceFiles = state.files.structure[currentPath];
            const fileIndex = sourceFiles.findIndex(f => f.name === fileName);
            if (fileIndex > -1) {
                const file = sourceFiles[fileIndex];
                sourceFiles.splice(fileIndex, 1);
                
                const targetPath = prompt('Taşınacak klasör yolunu girin:', currentPath);
                if (targetPath && state.files.structure[targetPath]) {
                    state.files.structure[targetPath].push(file);
                    FileSystem.saveFileSystem();
                    renderFiles();
                    showNotification('Dosyalar', `${fileName} taşındı`, 'file-export');
                } else {
                    sourceFiles.splice(fileIndex, 0, file);
                }
            }
        }
    });

    renderFiles();
}

function setupSettings(win) {
    const nav = win.querySelectorAll('.settings-nav-item');
    const content = win.querySelector('#settings-content');

    const sections = {
        general: () => `<div class="settings-section"><h3 class="settings-title">Genel Ayarlar</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Otomatik Güncellemeler</h4><p>Sistem güncellemelerini otomatik indir</p></div><div class="toggle ${state.settings.autoUpdate ? 'active' : ''}" data-setting="autoUpdate"></div></div><div class="settings-row"><div class="settings-row-info"><h4>Animasyonlar</h4><p>Arayüz animasyonlarını etkinleştir</p></div><div class="toggle ${state.settings.animations ? 'active' : ''}" data-setting="animations"></div></div><div class="settings-row"><div class="settings-row-info"><h4>Saat Formatı</h4><p>12 veya 24 saat formatı</p></div><select class="settings-select" id="time-format"><option value="24" ${state.settings.timeFormat === '24' ? 'selected' : ''}>24 Saat</option><option value="12" ${state.settings.timeFormat === '12' ? 'selected' : ''}>12 Saat</option></select></div><div class="settings-row"><div class="settings-row-info"><h4>Saatte Saniye Göster</h4><p>Görev çubuğunda saniyeleri göster</p></div><div class="toggle ${state.settings.showSeconds ? 'active' : ''}" data-setting="showSeconds"></div></div></div></div>`,
        display: () => `<div class="settings-section"><h3 class="settings-title">Ekran Ayarları</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Parlaklık</h4><p>Ekran parlaklığını ayarla</p></div><div class="slider-container"><input type="range" class="slider" min="20" max="100" value="${state.settings.brightness}" data-setting="brightness"><span class="slider-value">${state.settings.brightness}%</span></div></div><div class="settings-row"><div class="settings-row-info"><h4>Pencere Bulanıklığı</h4><p>Pencere arkaplan blur seviyesi</p></div><div class="slider-container"><input type="range" class="slider" min="0" max="50" value="${state.settings.windowBlur}" data-setting="windowBlur"><span class="slider-value">${state.settings.windowBlur}px</span></div></div><div class="settings-row"><div class="settings-row-info"><h4>Gece Işığı</h4><p>Mavi ışık filtresini etkinleştir</p></div><div class="toggle ${state.settings.nightLight ? 'active' : ''}" data-setting="nightLight"></div></div><div class="settings-row"><div class="settings-row-info"><h4>Otomatik Gece Modu</h4><p>Belirli saatlerde gece modunu aç</p></div><div class="toggle ${state.settings.autoNightMode ? 'active' : ''}" data-setting="autoNightMode"></div></div></div></div>`,
        sound: () => `<div class="settings-section"><h3 class="settings-title">Ses Ayarları</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Ana Ses</h4><p>Sistem ses seviyesi</p></div><div class="slider-container"><input type="range" class="slider" min="0" max="100" value="${state.settings.volume}" data-setting="volume"><span class="slider-value">${state.settings.volume}%</span></div></div></div></div>`,
        appearance: () => `<div class="settings-section"><h3 class="settings-title">Görünüm</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Tema Preseti</h4><p>Sistem temasını seçin</p></div><select class="settings-select" id="theme-preset"><option value="default" ${state.settings.themePreset === 'default' ? 'selected' : ''}>Varsayılan</option><option value="neon" ${state.settings.themePreset === 'neon' ? 'selected' : ''}>Neon</option><option value="matrix" ${state.settings.themePreset === 'matrix' ? 'selected' : ''}>Matrix</option><option value="classic" ${state.settings.themePreset === 'classic' ? 'selected' : ''}>Klasik</option></select></div><div class="settings-row"><div class="settings-row-info"><h4>Vurgu Rengi</h4<p>Sistemin ana rengini seçin</p></div><div class="color-options"><div class="color-option ${state.settings.accentColor === '#6366f1' ? 'active' : ''}" style="background:#6366f1;" data-color="#6366f1"></div><div class="color-option ${state.settings.accentColor === '#8b5cf6' ? 'active' : ''}" style="background:#8b5cf6;" data-color="#8b5cf6"></div><div class="color-option ${state.settings.accentColor === '#ec4899' ? 'active' : ''}" style="background:#ec4899;" data-color="#ec4899"></div><div class="color-option ${state.settings.accentColor === '#22c55e' ? 'active' : ''}" style="background:#22c55e;" data-color="#22c55e"></div><div class="color-option ${state.settings.accentColor === '#f59e0b' ? 'active' : ''}" style="background:#f59e0b;" data-color="#f59e0b"></div></div></div><div class="settings-row"><div class="settings-row-info"><h4>Mouse Teması</h4<p>Mouse imleç temasını seçin</p></div><select class="settings-select" id="mouse-theme"><option value="default" ${state.settings.mouseTheme === 'default' ? 'selected' : ''}>Varsayılan</option><option value="pointer" ${state.settings.mouseTheme === 'pointer' ? 'selected' : ''}>Pointer</option><option value="crosshair" ${state.settings.mouseTheme === 'crosshair' ? 'selected' : ''}>Crosshair</option><option value="text" ${state.settings.mouseTheme === 'text' ? 'selected' : ''}>Text</option><option value="wait" ${state.settings.mouseTheme === 'wait' ? 'selected' : ''}>Wait</option><option value="help" ${state.settings.mouseTheme === 'help' ? 'selected' : ''}>Help</option><option value="move" ${state.settings.mouseTheme === 'move' ? 'selected' : ''}>Move</option><option value="grab" ${state.settings.mouseTheme === 'grab' ? 'selected' : ''}>Grab</option></select></div></div><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Yazı Boyutu</h4><p>Sistem yazı boyutu</p></div><div class="slider-container"><input type="range" class="slider" min="12" max="20" value="${state.settings.fontSize}" data-setting="fontSize"><span class="slider-value">${state.settings.fontSize}px</span></div></div></div></div>`,
        notifications: () => `<div class="settings-section"><h3 class="settings-title">Bildirimler</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Bildirimler</h4><p>Sistem bildirimlerini göster</p></div><div class="toggle ${state.settings.notifications ? 'active' : ''}" data-setting="notifications"></div></div><div class="settings-row"><div class="settings-row-info"><h4>Sessiz Mod</h4><p>Tüm bildirimleri sessize al</p></div><div class="toggle ${state.settings.doNotDisturb ? 'active' : ''}" data-setting="doNotDisturb"></div></div><div class="settings-row"><div class="settings-row-info"><h4>Bildirim Geçmişi</h4><p>Geçmiş bildirimleri görüntüle</p></div><button class="btn btn-secondary" id="show-notif-history">Görüntüle</button></div></div></div>`,
        remote: () => `<div class="settings-section"><h3 class="settings-title">Uzaktan Kontrol</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Uzaktan Kontrol</h4><p>Uzaktan cihazdan fare ve klavye kontrolü</p></div><button class="btn btn-primary" id="remote-settings-btn"><i class="fas fa-mouse-pointer"></i> Ayarları Aç</button></div><div class="settings-row"><div class="settings-row-info"><h4>Durum</h4><p>${state.remoteControl.connected ? 'Bağlı' : 'Bağlı Değil'}</p></div><div class="remote-status-display ${state.remoteControl.connected ? 'connected' : 'disconnected'}"><span class="remote-status-dot ${state.remoteControl.connected ? 'connected' : 'disconnected'}"></span><span>${state.remoteControl.connected ? 'Bağlı' : 'Bağlı Değil'}</span></div></div><div class="settings-row"><div class="settings-row-info"><h4>Kısayol</h4><p>Ctrl + Alt + R ile aç/kapat</p></div><kbd style="padding:4px 8px;background:var(--bg-tertiary);border-radius:4px;font-size:12px;">Ctrl + Alt + R</kbd></div></div></div>`,
        experimental: () => `<div class="settings-section"><h3 class="settings-title">Deneysel Özellikler</h3><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Pencere Snap</h4><p>Pencereleri kenarlara sürükleyince yarım ekran yap</p></div><div class="toggle active" disabled></div></div><div class="settings-row"><div class="settings-row-info"><h4>Workspace Animasyonu</h4><p>Workspace geçişlerinde animasyon</p></div><div class="toggle ${state.settings.animations ? 'active' : ''}" disabled></div></div><div class="settings-row"><div class="settings-row-info"><h4>Pencere Sabitleme</h4><p>Pencereleri her zaman üstte tut</p></div><div class="toggle active" disabled></div></div><div class="settings-row"><div class="settings-row-info"><h4>Çoklu Pencere Seçimi</h4><p>Shift+tık ile çoklu pencere seç</p></div><div class="toggle active" disabled></div></div></div></div>`,
        about: () => `<div class="settings-section"><h3 class="settings-title">Sistem Hakkında</h3><div style="text-align:center;padding:20px;"><div style="width:80px;height:80px;background:linear-gradient(135deg,var(--accent),#8b5cf6);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:36px;font-weight:700;margin:0 auto 20px;">L</div><h2 style="font-size:24px;margin-bottom:8px;">Lunix OS</h2><p style="color:var(--text-muted);margin-bottom:24px;">Sürüm ${state.version}</p></div><div class="settings-group"><div class="settings-row"><div class="settings-row-info"><h4>Kullanıcı</h4><p>${state.users.current?.username || 'N/A'}</p></div></div><div class="settings-row"><div class="settings-row-info"><h4>Çalışma Süresi</h4><p id="about-uptime">0:00:00</p></div></div><div class="settings-row"><div class="settings-row-info"><h4>Açık Pencereler</h4><p>${state.windows.length}</p></div></div><div class="settings-row"><div class="settings-row-info"><h4>Çalışan İşlemler</h4><p>${ProcessManager.processes.length}</p></div></div></div></div>`
    };

    function loadSection(section) {
        content.innerHTML = sections[section]();
        nav.forEach(n => n.classList.toggle('active', n.dataset.section === section));

        content.querySelectorAll('.toggle').forEach(toggle => {
            if (!toggle.disabled) {
                toggle.onclick = () => {
                    toggle.classList.toggle('active');
                    const setting = toggle.dataset.setting;
                    if (setting && state.settings.hasOwnProperty(setting)) {
                        state.settings[setting] = toggle.classList.contains('active');
                        applySettings();
                        if (state.users.current) {
                            state.users.current.settings[setting] = state.settings[setting];
                            UserManager.saveUsers();
                        }
                    }
                };
            }
        });

        content.querySelectorAll('.slider').forEach(slider => {
            slider.oninput = () => {
                const val = parseInt(slider.value);
                const setting = slider.dataset.setting;
                slider.nextElementSibling.textContent = val + (setting === 'fontSize' || setting === 'windowBlur' ? 'px' : '%');
                if (setting && state.settings.hasOwnProperty(setting)) {
                    state.settings[setting] = val;
                    applySettings();
                    if (state.users.current) {
                        state.users.current.settings[setting] = val;
                        UserManager.saveUsers();
                    }
                }
            };
        });

        content.querySelectorAll('.color-option').forEach(opt => {
            opt.onclick = () => {
                content.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                state.settings.accentColor = opt.dataset.color;
                ThemeManager.applyTheme(opt.dataset.color);
                if (state.users.current) {
                    state.users.current.settings.accentColor = opt.dataset.color;
                    UserManager.saveUsers();
                }
            };
        });

        if (content.querySelector('#time-format')) {
            content.querySelector('#time-format').onchange = (e) => {
                state.settings.timeFormat = e.target.value;
                if (state.users.current) {
                    state.users.current.settings.timeFormat = e.target.value;
                    UserManager.saveUsers();
                }
            };
        }

        if (content.querySelector('#theme-preset')) {
            content.querySelector('#theme-preset').onchange = (e) => {
                state.settings.themePreset = e.target.value;
                ThemeManager.applyPreset(e.target.value);
                if (state.users.current) {
                    state.users.current.settings.themePreset = e.target.value;
                    UserManager.saveUsers();
                }
            };
        }

        if (content.querySelector('#mouse-theme')) {
            content.querySelector('#mouse-theme').onchange = (e) => {
                state.settings.mouseTheme = e.target.value;
                applyMouseTheme();
                if (state.users.current) {
                    state.users.current.settings.mouseTheme = e.target.value;
                    UserManager.saveUsers();
                }
            };
        }

        if (content.querySelector('#show-notif-history')) {
            content.querySelector('#show-notif-history').onclick = () => {
                const history = NotificationService.getHistory();
                const historyWin = createWindow('terminal');
                const terminalOutput = historyWin.element.querySelector('.terminal-output');
                if (terminalOutput) {
                    historyWin.element.querySelector('.terminal-input').value = '';
                    historyWin.element.querySelector('.terminal-output').innerHTML += 
                        history.map(h => `<div class="terminal-line">${new Date(h.time).toLocaleTimeString()}: ${h.title} - ${h.message}</div>`).join('');
                }
                showNotification('Bildirimler', 'Bildirim geçmişi terminalde açıldı', 'history');
            };
        }

        if (content.querySelector('#remote-settings-btn')) {
            content.querySelector('#remote-settings-btn').onclick = () => {
                createWindow('remote');
            };
        }

        if (section === 'about') {
            setInterval(() => {
                const el = content.querySelector('#about-uptime');
                if (el) {
                    const ms = Date.now() - state.bootTime;
                    const h = Math.floor(ms / 3600000);
                    const m = Math.floor((ms % 3600000) / 60000);
                    const s = Math.floor((ms % 60000) / 1000);
                    el.textContent = `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
                }
            }, 1000);
        }
    }

    nav.forEach(item => { item.onclick = () => loadSection(item.dataset.section); });
    loadSection('general');
}

function setupTaskManager(win) {
    function render() {
        const list = win.querySelector('#taskmgr-list');
        const procs = ProcessManager.getProcesses();
        list.innerHTML = procs.map(p => `
            <tr style="border-bottom:1px solid var(--border);cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.03)'" onmouseout="this.style.background='transparent'">
                <td style="padding:12px;font-size:13px;">${p.name}</td>
                <td style="padding:12px;text-align:right;font-size:13px;">${p.pid}</td>
                <td style="padding:12px;text-align:right;font-size:13px;">${p.cpu.toFixed(1)}%</td>
                <td style="padding:12px;text-align:right;font-size:13px;">${p.memory.toFixed(1)}%</td>
                <td style="padding:12px;text-align:right;font-size:13px;color:${p.status === 'running' ? 'var(--success)' : 'var(--text-muted)'};">${p.status}</td>
            </tr>
        `).join('');
    }
    
    render();
    const interval = setInterval(render, 2000);
    win.querySelector('#taskmgr-refresh').onclick = render;
    
    win.querySelector('#taskmgr-end').onclick = () => {
        const pid = prompt('Sonlandırılacak PID:');
        if (pid) {
            ProcessManager.killProcess(parseInt(pid));
            render();
        }
    };
    
    win.querySelector('#taskmgr-slow').onclick = () => {
        state.slowMode = !state.slowMode;
        win.querySelector('#taskmgr-slow').innerHTML = state.slowMode ? 
            '<i class="fas fa-bolt"></i> Normal Mod' : 
            '<i class="fas fa-turtle"></i> Yavaş Mod';
        showNotification('Sistem', state.slowMode ? 'Yavaş mod etkin' : 'Normal moda dönüldü', state.slowMode ? 'turtle' : 'bolt');
    };
}

function setupUserManager(win) {
    function render() {
        const list = win.querySelector('#users-list');
        list.innerHTML = state.users.list.map(u => `
            <div style="padding:16px;background:rgba(0,0,0,0.2);border-radius:12px;margin-bottom:12px;display:flex;align-items:center;gap:16px;">
                <div style="width:50px;height:50px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:20px;">${u.avatar}</div>
                <div style="flex:1;">
                    <div style="font-size:16px;font-weight:500;margin-bottom:4px;">${u.username}</div>
                    <div style="font-size:12px;color:var(--text-muted);">${u.isAdmin ? 'Yönetici' : 'Kullanıcı'} • Son giriş: ${u.lastLogin ? new Date(u.lastLogin).toLocaleString('tr-TR') : 'Hiç'}</div>
                </div>
                ${u.id !== state.users.current?.id ? `<button class="files-toolbar-btn" onclick="if(confirm('${u.username} kullanıcısını silmek istediğinizden emin misiniz?')){UserManager.deleteUser('${u.id}');document.querySelector('#users-list').closest('.window').dispatchEvent(new Event('reload'));}"><i class="fas fa-trash"></i></button>` : ''}
            </div>
        `).join('');
    }
    
    render();
    win.addEventListener('reload', render);
    win.querySelector('#users-add').onclick = () => {
        document.getElementById('new-user-modal').style.display = 'flex';
    };
}

function setupBrowser(win) {
    const frame = win.querySelector('#browser-frame');
    const urlInput = win.querySelector('#browser-url');
    
    win.querySelector('#browser-back').onclick = () => {
        try { frame.contentWindow.history.back(); } catch {}
    };
    
    win.querySelector('#browser-forward').onclick = () => {
        try { frame.contentWindow.history.forward(); } catch {}
    };
    
    win.querySelector('#browser-refresh').onclick = () => {
        frame.src = frame.src;
    };
    
    urlInput.addEventListener('keydown', (e) => {
        if (state.remoteControl.isActive) {
            e.preventDefault();
            e.stopPropagation();
            return;
        }
        
        if (e.key === 'Enter') {
            let url = urlInput.value.trim();
            // GOOGLE DÜZELTMESİ: Tüm URL'ler için destek
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            frame.src = url;
            urlInput.value = url;
        }
    });
    
    // GOOGLE DÜZELTMESİ: Varsayılan olarak Google aç
    frame.src = 'https://www.google.com';
    urlInput.value = 'https://www.google.com';
}

function setupTrash(win) {
    const grid = win.querySelector('#trash-grid');
    
    function render() {
        grid.innerHTML = state.trash.length === 0 
            ? '<div style="grid-column:1/-1;text-align:center;padding:60px;color:var(--text-muted);"><i class="fas fa-trash" style="font-size:48px;margin-bottom:16px;display:block;opacity:0.3;"></i>Çöp kutusu boş</div>'
            : state.trash.map((f, i) => 
                `<div class="file-item" data-index="${i}"><i class="fas fa-${f.type === 'folder' ? 'folder' : 'file'}" style="color:#6b7280;"></i><span>${f.name}</span><div style="font-size:9px;color:var(--text-muted);">${new Date(f.deletedAt).toLocaleDateString()}</div></div>`
            ).join('');
        
        grid.querySelectorAll('.file-item').forEach(item => {
            item.onclick = () => {
                grid.querySelectorAll('.file-item').forEach(i => i.classList.remove('selected'));
                item.classList.add('selected');
                win.querySelector('#trash-restore').disabled = false;
            };
        });
    }
    
    render();
    
    win.querySelector('#trash-empty').onclick = () => {
        if (confirm('Çöp kutusunu boşaltmak istediğinizden emin misiniz?')) {
            state.trash = [];
            render();
            showNotification('Çöp Kutusu', 'Boşaltıldı', 'trash');
        }
    };
    
    win.querySelector('#trash-restore').onclick = () => {
        const selected = grid.querySelector('.file-item.selected');
        if (selected) {
            const index = parseInt(selected.dataset.index);
            FileSystem.restore(state.trash[index]);
            render();
            win.querySelector('#trash-restore').disabled = true;
        }
    };
    
    win.querySelector('#trash-refresh').onclick = render;
}

function setupRemoteControl(win) {
    const digits = [
        win.querySelector('#remoteWindowDigit1'),
        win.querySelector('#remoteWindowDigit2'),
        win.querySelector('#remoteWindowDigit3')
    ];
    
    const connectBtn = win.querySelector('#remoteWindowConnect');
    const disconnectBtn = win.querySelector('#remoteWindowDisconnect');
    const statusDisplay = win.querySelector('#remoteWindowStatus');
    const keyHistory = win.querySelector('#remoteWindowKeyHistory');
    
    if (state.remoteControl.connected) {
        digits[0].value = state.remoteControl.code[0] || '';
        digits[1].value = state.remoteControl.code[1] || '';
        digits[2].value = state.remoteControl.code[2] || '';
        digits.forEach(d => d.classList.add('filled'));
    }
    
    function updateUI() {
        if (state.remoteControl.connected) {
            statusDisplay.className = 'remote-status-display connected';
            statusDisplay.innerHTML = `<span class="remote-status-dot connected"></span><span>Bağlı</span>`;
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-link"></i><span>Bağlı</span>';
            disconnectBtn.disabled = false;
            digits.forEach(d => d.disabled = true);
        } else if (state.remoteControl.peer && state.remoteControl.connection) {
            statusDisplay.className = 'remote-status-display connecting';
            statusDisplay.innerHTML = `<span class="remote-status-dot connecting"></span><span>Bağlanıyor...</span>`;
            connectBtn.disabled = true;
            connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Bağlanıyor...</span>';
            disconnectBtn.disabled = false;
            digits.forEach(d => d.disabled = true);
        } else {
            statusDisplay.className = 'remote-status-display disconnected';
            statusDisplay.innerHTML = `<span class="remote-status-dot disconnected"></span><span>Bağlı Değil</span>`;
            connectBtn.disabled = false;
            connectBtn.innerHTML = '<i class="fas fa-link"></i><span>Bağlan</span>';
            disconnectBtn.disabled = true;
            digits.forEach(d => d.disabled = false);
        }
        
        if (state.remoteControl.lastKeys.length > 0) {
            keyHistory.innerHTML = state.remoteControl.lastKeys.slice(-15).map(key => 
                `<span class="key-history-item">${key}</span>`
            ).join('');
        } else {
            keyHistory.innerHTML = '<span style="color: var(--text-muted);">Henüz tuş girilmedi</span>';
        }
    }
    
    digits.forEach((digit, index) => {
        digit.addEventListener('input', (e) => {
            const value = e.target.value.replace(/[^0-9]/g, '');
            e.target.value = value;
            
            if (value) {
                e.target.classList.add('filled');
                if (index < 2) {
                    digits[index + 1].focus();
                }
            } else {
                e.target.classList.remove('filled');
            }
        });
        
        digit.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                digits[index - 1].focus();
            }
            if (e.key === 'Enter') {
                connectBtn.click();
            }
        });
        
        digit.addEventListener('paste', (e) => {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 3);
            
            pastedData.split('').forEach((char, i) => {
                if (digits[i]) {
                    digits[i].value = char;
                    digits[i].classList.add('filled');
                }
            });
            
            if (pastedData.length === 3) {
                digits[2].focus();
            }
        });
    });
    
    connectBtn.onclick = () => {
        const code = digits.map(d => d.value).join('');
        if (code.length === 3) {
            RemoteControlManager.connect(code);
            updateUI();
        } else {
            showNotification('Hata', 'Lütfen 3 haneli kod girin', 'exclamation-triangle');
        }
    };
    
    disconnectBtn.onclick = () => {
        RemoteControlManager.disconnect();
        updateUI();
    };
    
    updateUI();
    
    const updateInterval = setInterval(() => {
        if (win.closest('.window') && !win.closest('.window').classList.contains('closing')) {
            updateUI();
        } else {
            clearInterval(updateInterval);
        }
    }, 1000);
}

// ========================================
// UTILITY FUNCTIONS
// ========================================
function debugLog(message) {
    const consoleEl = document.getElementById('debug-console');
    const log = document.createElement('div');
    log.className = 'debug-log';
    log.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    consoleEl.appendChild(log);
    consoleEl.scrollTop = consoleEl.scrollHeight;
    console.log(message);
}

function showBlueScreen() {
    const blueScreen = document.getElementById('blue-screen');
    const progressBar = blueScreen.querySelector('.blue-screen-progress-bar');
    
    blueScreen.style.display = 'flex';
    setTimeout(() => {
        progressBar.style.width = '100%';
        setTimeout(() => {
            blueScreen.style.display = 'none';
            progressBar.style.width = '0%';
            setTimeout(() => {
                location.reload();
            }, 500);
        }, 3000);
    }, 100);
}

function initializeDragAndDrop() {
    const desktop = document.getElementById('desktop');
    const selectionBox = document.getElementById('selection-box');
    let isSelecting = false;
    let startX, startY;

    desktop.addEventListener('mousedown', (e) => {
        if (e.target === desktop || e.target.closest('#desktop') === desktop) {
            isSelecting = true;
            startX = e.clientX;
            startY = e.clientY;
            selectionBox.style.left = startX + 'px';
            selectionBox.style.top = startY + 'px';
            selectionBox.style.width = '0';
            selectionBox.style.height = '0';
            selectionBox.style.display = 'block';
        }
    });

    desktop.addEventListener('mousemove', (e) => {
        if (isSelecting) {
            const currentX = e.clientX;
            const currentY = e.clientY;
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);
            const left = Math.min(currentX, startX);
            const top = Math.min(currentY, startY);
            
            selectionBox.style.left = left + 'px';
            selectionBox.style.top = top + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            
            document.querySelectorAll('.desktop-icon').forEach(icon => {
                const rect = icon.getBoundingClientRect();
                if (rect.left >= left && rect.right <= left + width &&
                    rect.top >= top && rect.bottom <= top + height) {
                    icon.classList.add('selected');
                }
            });
        }
    });

    desktop.addEventListener('mouseup', () => {
        isSelecting = false;
        selectionBox.style.display = 'none';
    });
}

// ========================================
// EVENT LISTENERS
// ========================================
function setupEventListeners() {
    document.getElementById('start-btn').onclick = () => {
        const menu = document.getElementById('start-menu');
        menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    };

    document.getElementById('settings-shortcut').onclick = () => {
        createWindow('settings');
        document.getElementById('start-menu').style.display = 'none';
    };

    document.getElementById('switch-user-btn').onclick = () => {
        UserManager.logout();
        document.getElementById('start-menu').style.display = 'none';
    };

    document.getElementById('power-btn').onclick = () => {
        document.getElementById('start-menu').style.display = 'none';
        document.getElementById('power-menu').style.display = 'flex';
    };

    document.getElementById('lock-btn').onclick = lockSystem;

    document.querySelectorAll('.power-option').forEach(opt => {
        opt.onclick = () => {
            const action = opt.dataset.action;
            document.getElementById('power-menu').style.display = 'none';
            
            if (action === 'lock') {
                lockSystem();
            } else if (action === 'restart') {
                showNotification('Sistem', 'Yeniden başlatılıyor...', 'redo');
                setTimeout(() => {
                    document.body.innerHTML = `
                        <div style="height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;background:#000;color:#0f0;font-family:monospace;font-size:16px;">
                            <div>[  OK  ] Stopping services...</div>
                            <div>[  OK  ] Unmounting filesystems...</div>
                            <div>[  OK  ] Rebooting system...</div>
                            <br>
                            <div>Reboot completed. Press any key to continue...</div>
                        </div>
                    `;
                    document.addEventListener('keydown', () => location.reload());
                }, 2000);
            } else if (action === 'shutdown') {
                showNotification('Sistem', 'Kapatılıyor...', 'power-off');
                setTimeout(() => {
                    document.body.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;background:#000;color:#fff;font-size:24px;">Sistem kapatıldı</div>';
                }, 2000);
            }
        };
    });

    document.getElementById('power-menu').onclick = (e) => {
        if (e.target.id === 'power-menu') {
            document.getElementById('power-menu').style.display = 'none';
        }
    };

    document.getElementById('lock-password').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') unlockSystem();
    });

    document.getElementById('lock-submit').onclick = unlockSystem;

    document.getElementById('lock-back-btn').onclick = () => {
        document.getElementById('lock-screen').classList.remove('active');
        UserManager.showUserSelect();
    };

    document.getElementById('search-btn').onclick = () => {
        document.getElementById('search-modal').style.display = 'flex';
        document.getElementById('search-input').focus();
    };

    document.getElementById('search-modal').onclick = (e) => {
        if (e.target.id === 'search-modal') {
            document.getElementById('search-modal').style.display = 'none';
        }
    };

    document.getElementById('search-input').oninput = (e) => {
        if (state.remoteControl.isActive) return;
        
        const query = e.target.value.toLowerCase();
        const results = apps.filter(a => a.name.toLowerCase().includes(query));
        document.getElementById('search-results').innerHTML = results.map(a => `
            <div class="search-result-item" data-app="${a.id}">
                <div class="search-result-icon ${a.iconClass}"><i class="fas ${a.icon}"></i></div>
                <div class="search-result-info">
                    <h4>${a.name}</h4>
                    <span>Uygulama</span>
                </div>
            </div>
        `).join('');
        
        document.querySelectorAll('.search-result-item').forEach(item => {
            item.onclick = () => {
                createWindow(item.dataset.app);
                document.getElementById('search-modal').style.display = 'none';
                document.getElementById('search-input').value = '';
            };
        });
    };

    const desktop = document.getElementById('desktop');
    desktop.addEventListener('contextmenu', (e) => {
        if (e.target === desktop || (e.target.closest('#desktop') && !e.target.closest('.desktop-icon'))) {
            e.preventDefault();
            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = Math.min(e.clientX, window.innerWidth - 220) + 'px';
            menu.style.top = Math.min(e.clientY, window.innerHeight - 250) + 'px';
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('#context-menu')) {
            document.getElementById('context-menu').style.display = 'none';
        }
        if (!e.target.closest('#start-menu') && !e.target.closest('#start-btn')) {
            document.getElementById('start-menu').style.display = 'none';
        }
    });

    document.querySelectorAll('.context-item').forEach(item => {
        item.onclick = () => {
            const action = item.dataset.action;
            document.getElementById('context-menu').style.display = 'none';
            
            if (action === 'refresh') {
                showNotification('Sistem', 'Masaüstü yenilendi', 'sync-alt');
            } else if (action === 'terminal') {
                createWindow('terminal');
            } else if (action === 'settings') {
                createWindow('settings');
            } else if (action === 'change-bg') {
                document.getElementById('bg-file-input').click();
            } else if (action === 'new-folder') {
                showNotification('Dosyalar', 'Yeni klasör oluşturuldu', 'folder-plus');
            } else if (action === 'paste') {
                FileSystem.paste();
            } else if (action === 'about') {
                showNotification('Lunix OS', `Sürüm ${state.version} - Modern Masaüstü`, 'info-circle');
            }
        };
    });

    document.getElementById('bg-file-input').onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                desktop.style.backgroundImage = `url(${ev.target.result})`;
                desktop.style.backgroundSize = 'cover';
                desktop.style.backgroundPosition = 'center';
                if (state.users.current) {
                    state.users.current.desktop.wallpaper = ev.target.result;
                    UserManager.saveUsers();
                }
                showNotification('Görünüm', 'Arkaplan değiştirildi', 'image');
            };
            reader.readAsDataURL(file);
        }
    };

    document.querySelectorAll('.workspace-dot').forEach(dot => {
        dot.onclick = () => {
            const direction = parseInt(dot.dataset.workspace) > state.currentWorkspace ? 'right' : 'left';
            switchWorkspace(parseInt(dot.dataset.workspace), direction);
        };
    });

    document.getElementById('create-user-btn').onclick = () => {
        const username = document.getElementById('new-user-name').value.trim();
        const password = document.getElementById('new-user-pass').value;
        
        if (!username || !password) {
            showNotification('Hata', 'Kullanıcı adı ve şifre gerekli', 'exclamation-triangle');
            return;
        }
        
        if (state.users.list.some(u => u.username === username)) {
            showNotification('Hata', 'Bu kullanıcı adı zaten kullanılıyor', 'exclamation-triangle');
            return;
        }
        
        UserManager.createUser(username, password, false);
        document.getElementById('new-user-modal').style.display = 'none';
        document.getElementById('new-user-name').value = '';
        document.getElementById('new-user-pass').value = '';
        showNotification('Başarılı', `${username} kullanıcısı oluşturuldu`, 'user-check');
        
        const userWin = state.windows.find(w => w.app === 'users');
        if (userWin) {
            userWin.element.dispatchEvent(new Event('reload'));
        }
    };

    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            document.getElementById('search-modal').style.display = 'none';
            document.getElementById('power-menu').style.display = 'none';
            document.getElementById('new-user-modal').style.display = 'none';
            document.getElementById('file-preview').style.display = 'none';
        }
    });

    let dragCounter = 0;
    
    document.addEventListener('dragenter', (e) => {
        e.preventDefault();
        dragCounter++;
        document.getElementById('drag-drop-overlay').classList.add('active');
    });

    document.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dragCounter--;
        if (dragCounter === 0) {
            document.getElementById('drag-drop-overlay').classList.remove('active');
        }
    });

    document.addEventListener('dragover', (e) => {
        e.preventDefault();
    });

    document.addEventListener('drop', (e) => {
        e.preventDefault();
        dragCounter = 0;
        document.getElementById('drag-drop-overlay').classList.remove('active');
        
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
            showNotification('Dosyalar', `${files.length} dosya yüklendi`, 'upload');
            
            files.forEach(file => {
                const currentFiles = state.files.structure[state.files.currentPath] || [];
                currentFiles.push({
                    name: file.name,
                    type: file.type.includes('image') ? 'image' : 'file',
                    size: (file.size / 1024).toFixed(1) + ' KB',
                    created: Date.now()
                });
            });
            
            FileSystem.saveFileSystem();
            EventBus.emit('files:changed');
        }
    });

    document.addEventListener('mousedown', (e) => {
        if (e.target.closest('.window')) {
            const win = e.target.closest('.window');
            const id = parseInt(win.id.replace('window-', ''));
            focusWindow(id);
        }
    });

    window.addEventListener('beforeunload', () => {
        UserManager.saveSession();
        RemoteControlManager.disconnect();
    });

    EventBus.on('notification:shown', () => {
        const badge = document.querySelector('#notif-btn .tray-badge');
        badge.style.display = 'block';
        setTimeout(() => {
            badge.style.display = 'none';
        }, 3000);
    });

    if (state.users.current?.desktop?.wallpaper) {
        desktop.style.backgroundImage = `url(${state.users.current.desktop.wallpaper})`;
        desktop.style.backgroundSize = 'cover';
        desktop.style.backgroundPosition = 'center';
    }
}

// ========================================
// SYSTEM INITIALIZATION
// ========================================
function init() {
    console.log('%c🚀 Lunix OS ' + state.version, 'color: #6366f1; font-size: 20px; font-weight: bold;');
    console.log('%cTam işlevsel masaüstü sistemi - 50+ özellik aktif', 'color: #8b5cf6; font-size: 12px;');
    debugLog('System initialization started');
    
    UserManager.init();
    KeyboardManager.init();
    
    setupEventListeners();
    
    bootSystem();
    
    EventBus.on('files:changed', () => {
        const filesWin = state.windows.find(w => w.app === 'files');
        if (filesWin) {
            const refreshBtn = filesWin.element.querySelector('#files-refresh');
            if (refreshBtn) refreshBtn.click();
        }
        const trashWin = state.windows.find(w => w.app === 'trash');
        if (trashWin) {
            trashWin.element.dispatchEvent(new Event('reload'));
        }
    });
    
    setInterval(() => {
        state.windows.forEach(w => {
            if (Math.random() < 0.001) {
                handleWindowCrash(w.id);
            }
        });
    }, 5000);
    
    setInterval(() => {
        if (state.users.current) {
            UserManager.saveSession();
            debugLog('Session auto-saved');
        }
    }, 30000);
    
    console.log('%c✅ Sistem başarıyla yüklendi', 'color: #22c55e; font-size: 12px;');
    debugLog('System initialization completed');
}

init();
</script>
</body>
</html>
